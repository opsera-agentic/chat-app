# Temporary workflow to debug ArgoCD
name: "ðŸ” Debug: ArgoCD Status"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  APP_NAME: chat-app-qa

permissions:
  contents: read
  id-token: write

jobs:
  debug:
    name: "ðŸ” Check ArgoCD Status"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check ArgoCD Application
        run: |
          echo "## ðŸŽ¯ ArgoCD Application Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Application List" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get applications -n argocd 2>&1 | grep -E "(NAME|chat-app)" || echo "No chat-app applications found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Get Application Details
        run: |
          echo "### Application Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }} -n argocd -o yaml 2>&1 | head -100 || echo "Application not found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Sync Status
        run: |
          echo "### Sync Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }} -n argocd -o jsonpath='{.status.sync.status}' 2>&1 && echo ""
          kubectl get application ${{ env.APP_NAME }} -n argocd -o jsonpath='{.status.health.status}' 2>&1 && echo ""
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Sync Errors" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application ${{ env.APP_NAME }} -n argocd -o jsonpath='{.status.conditions[*].message}' 2>&1 || echo "No conditions"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Describe Application
        run: |
          echo "### Full Application Description" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe application ${{ env.APP_NAME }} -n argocd 2>&1 | head -150 || echo "Could not describe"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Force Sync (if needed)
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Triggering Sync" >> $GITHUB_STEP_SUMMARY
          
          # Hard refresh
          kubectl patch application ${{ env.APP_NAME }} -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}' 2>&1 || echo "Could not refresh"
          
          sleep 5
          
          # Trigger sync
          kubectl patch application ${{ env.APP_NAME }} -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"debug-workflow"},"sync":{"prune":true}}}' 2>&1 || echo "Could not sync"
          
          echo "Sync triggered - check ArgoCD UI for details" >> $GITHUB_STEP_SUMMARY
