# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  BOOTSTRAP INFRASTRUCTURE - One-time setup for sperigpt-01                   â•‘
# â•‘  Code-to-Cloud v0.6 - Powered by Opsera                                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸš€ sperigpt-01: 00 Bootstrap"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - all
        default: 'all'

env:
  AWS_REGION: us-west-2
  TENANT: opsera
  APP_NAME: sperigpt-01

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DISCOVER INFRASTRUCTURE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  discover:
    name: "ğŸ” Discover Infrastructure"
    runs-on: ubuntu-latest
    outputs:
      hub_cluster: ${{ steps.discover.outputs.hub_cluster }}
      spoke_cluster: ${{ steps.discover.outputs.spoke_cluster }}
      region_short: ${{ steps.discover.outputs.region_short }}
      ecr_uri: ${{ steps.discover.outputs.ecr_uri }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover Clusters and Generate Names
        id: discover
        run: |
          # Generate region short code
          case "${{ env.AWS_REGION }}" in
            us-west-2) REGION_SHORT="usw2" ;;
            us-east-1) REGION_SHORT="use1" ;;
            us-west-1) REGION_SHORT="usw1" ;;
            eu-west-1) REGION_SHORT="euw1" ;;
            *) REGION_SHORT=$(echo "${{ env.AWS_REGION }}" | sed 's/-//g' | cut -c1-4) ;;
          esac

          HUB_CLUSTER="argocd-${REGION_SHORT}"
          SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-np"

          # RULE 7: Get AWS Account ID dynamically
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

          echo "hub_cluster=${HUB_CLUSTER}" >> $GITHUB_OUTPUT
          echo "spoke_cluster=${SPOKE_CLUSTER}" >> $GITHUB_OUTPUT
          echo "region_short=${REGION_SHORT}" >> $GITHUB_OUTPUT
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT

          echo "### ğŸ” Infrastructure Discovery" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Hub Cluster | \`${HUB_CLUSTER}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke Cluster | \`${SPOKE_CLUSTER}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR URI | \`${ECR_URI}\` |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PRE-FLIGHT CHECKS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  preflight:
    name: "âœ… Pre-flight Checks"
    runs-on: ubuntu-latest
    needs: [discover]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: CHECK 1 - Verify Clusters Exist
        run: |
          echo "### âœ… Pre-flight Checks" >> $GITHUB_STEP_SUMMARY

          echo "Checking Hub cluster: ${{ needs.discover.outputs.hub_cluster }}"
          aws eks describe-cluster --name ${{ needs.discover.outputs.hub_cluster }} --region ${{ env.AWS_REGION }}
          echo "- âœ… Hub cluster exists" >> $GITHUB_STEP_SUMMARY

          echo "Checking Spoke cluster: ${{ needs.discover.outputs.spoke_cluster }}"
          aws eks describe-cluster --name ${{ needs.discover.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}
          echo "- âœ… Spoke cluster exists" >> $GITHUB_STEP_SUMMARY

      - name: CHECK 2 - Verify Argo Rollouts Installed
        run: |
          aws eks update-kubeconfig --name ${{ needs.discover.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}

          if kubectl get crd rollouts.argoproj.io &>/dev/null; then
            echo "- âœ… Argo Rollouts is installed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Argo Rollouts not found - installing..."
            kubectl create namespace argo-rollouts || true
            kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml
            echo "- âœ… Argo Rollouts installed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: CHECK 3 - Verify Dockerfiles Exist
        run: |
          if [ -f ".opsera-${{ env.APP_NAME }}/Dockerfile.frontend" ] && [ -f ".opsera-${{ env.APP_NAME }}/Dockerfile.backend" ]; then
            echo "- âœ… Dockerfiles exist" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Dockerfiles not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ECR REPOSITORIES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-ecr:
    name: "ğŸ³ Create ECR Repositories"
    runs-on: ubuntu-latest
    needs: [discover, preflight]

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repositories
        run: |
          echo "### ğŸ³ ECR Repositories" >> $GITHUB_STEP_SUMMARY

          for SERVICE in ${{ env.APP_NAME }}-frontend ${{ env.APP_NAME }}-backend; do
            if aws ecr describe-repositories --repository-names $SERVICE 2>/dev/null; then
              echo "- âœ… \`$SERVICE\` already exists" >> $GITHUB_STEP_SUMMARY
            else
              aws ecr create-repository --repository-name $SERVICE \
                --image-scanning-configuration scanOnPush=true
              echo "- âœ… \`$SERVICE\` created" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SETUP ARGOCD APPLICATIONS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup-argocd:
    name: "ğŸ”§ Setup ArgoCD (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: [discover, preflight, create-ecr]
    strategy:
      matrix:
        environment: ${{ fromJSON(inputs.environment == 'all' && '["dev", "qa", "staging"]' || format('["{0}"]', inputs.environment)) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Update ArgoCD Application Manifest
        run: |
          APP_MANIFEST=".opsera-${{ env.APP_NAME }}/argocd/application-${{ matrix.environment }}.yaml"
          REPO_URL=$(git remote get-url origin)

          sed -i "s|PLACEHOLDER_REPO_URL|${REPO_URL}|g" "$APP_MANIFEST"
          echo "âœ… Updated ArgoCD manifest with repo: ${REPO_URL}"

      - name: Update Kustomization with ECR URI
        run: |
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${{ matrix.environment }}/kustomization.yaml"
          ECR_URI="${{ needs.discover.outputs.ecr_uri }}"

          sed -i "s|PLACEHOLDER_ECR_URI|${ECR_URI}|g" "$KUSTOMIZE_FILE"
          echo "âœ… Updated kustomization with ECR: ${ECR_URI}"

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true
          git add .
          git diff --staged --quiet || git commit -m "chore: configure ${{ env.APP_NAME }} for ${{ matrix.environment }} [skip ci]"
          git push origin main || echo "No changes to push"

      - name: Connect to Hub and Apply ArgoCD Application
        run: |
          aws eks update-kubeconfig --name ${{ needs.discover.outputs.hub_cluster }} --region ${{ env.AWS_REGION }}

          # Create/update ArgoCD repo secret (idempotent with kubectl apply)
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: repo-${{ github.repository_owner }}-${{ env.APP_NAME }}
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repository
          type: Opaque
          stringData:
            url: $(git remote get-url origin)
            password: ${{ secrets.GH_PAT }}
            username: git
            type: git
          EOF

          # Apply ArgoCD Application
          kubectl apply -f .opsera-${{ env.APP_NAME }}/argocd/application-${{ matrix.environment }}.yaml

          echo "### ğŸ¯ ArgoCD Application: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application \`${{ env.APP_NAME }}-${{ matrix.environment }}\` created" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ğŸ“‹ Bootstrap Summary"
    runs-on: ubuntu-latest
    needs: [discover, preflight, create-ecr, setup-argocd]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ğŸš€ Bootstrap Complete for sperigpt-01" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Endpoints (after HTTPS setup)" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | \`https://opsera-sperigpt-01-dev.agent.opsera.dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | \`https://opsera-sperigpt-01-qa.agent.opsera.dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | \`https://opsera-sperigpt-01-staging.agent.opsera.dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Preview | \`https://preview.opsera-sperigpt-01-staging.agent.opsera.dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run **sperigpt-01: 20 CI Build & Push** to build Docker images" >> $GITHUB_STEP_SUMMARY
          echo "2. Run **sperigpt-01: 30 HTTPS Setup** for SSL certificates" >> $GITHUB_STEP_SUMMARY
