# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  QUALITY & SECURITY GATES - Parallel scanning with enterprise guardrails     â•‘
# â•‘  sperigpt-01 - Code-to-Cloud v0.6 - Powered by Opsera                        â•‘
# â•‘                                                                               â•‘
# â•‘  SCANS: SAST (SonarQube) | SCA (Grype) | Secrets (Gitleaks) | Container      â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”’ sperigpt-01: 10 Quality & Security Gates"

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
  workflow_dispatch:
    inputs:
      skip_sonar:
        description: 'Skip SonarQube analysis'
        required: false
        type: boolean
        default: false
      skip_grype:
        description: 'Skip Grype vulnerability scan'
        required: false
        type: boolean
        default: false
      fail_on_critical:
        description: 'Fail on CRITICAL vulnerabilities'
        required: false
        type: boolean
        default: true

env:
  APP_NAME: sperigpt-01

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECRET DETECTION (Gitleaks)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secrets-scan:
    name: "ðŸ” Secrets Detection"
    runs-on: ubuntu-latest
    outputs:
      secrets_found: ${{ steps.gitleaks.outputs.secrets_found }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate Results
        run: |
          if [ "${{ steps.gitleaks.outcome }}" = "failure" ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "### ðŸš¨ Secrets Detected!" >> $GITHUB_STEP_SUMMARY
            echo "Please remove any exposed secrets before merging." >> $GITHUB_STEP_SUMMARY
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
            echo "### âœ… No Secrets Found" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SAST - SonarQube Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sast-sonarqube:
    name: "ðŸ” SAST (SonarQube)"
    runs-on: ubuntu-latest
    if: inputs.skip_sonar != true
    outputs:
      quality_gate: ${{ steps.sonar.outputs.quality_gate }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Run Frontend Tests with Coverage
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npm test -- --coverage --watchAll=false --passWithNoTests || true

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt || true
          pip install pytest pytest-cov || true

      - name: Run Backend Tests with Coverage
        working-directory: ./backend
        continue-on-error: true
        run: |
          pytest --cov=. --cov-report=xml || true

      - name: SonarQube Scan
        id: sonar
        uses: sonarsource/sonarqube-scan-action@master
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL || 'https://sonarcloud.io' }}
        with:
          args: >
            -Dsonar.projectKey=${{ env.APP_NAME }}
            -Dsonar.organization=${{ github.repository_owner }}
            -Dsonar.sources=frontend/src,backend
            -Dsonar.exclusions=**/node_modules/**,**/*.test.*,**/tests/**
            -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
            -Dsonar.python.coverage.reportPaths=backend/coverage.xml

      - name: Check Quality Gate
        id: quality-gate
        run: |
          if [ "${{ steps.sonar.outcome }}" = "success" ]; then
            echo "quality_gate=passed" >> $GITHUB_OUTPUT
            echo "### âœ… SonarQube Quality Gate Passed" >> $GITHUB_STEP_SUMMARY
          else
            # Allow continue if SonarQube not configured
            if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
              echo "quality_gate=skipped" >> $GITHUB_OUTPUT
              echo "### â­ï¸ SonarQube Skipped (not configured)" >> $GITHUB_STEP_SUMMARY
            else
              echo "quality_gate=failed" >> $GITHUB_OUTPUT
              echo "### âŒ SonarQube Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SCA - Grype Vulnerability Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sca-grype:
    name: "ðŸ›¡ï¸ SCA (Grype)"
    runs-on: ubuntu-latest
    if: inputs.skip_grype != true
    outputs:
      vulnerabilities: ${{ steps.grype.outputs.vulnerabilities }}
      critical_count: ${{ steps.grype.outputs.critical_count }}
      high_count: ${{ steps.grype.outputs.high_count }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Scan Frontend Dependencies
        id: grype-frontend
        uses: anchore/scan-action@v3
        continue-on-error: true
        with:
          path: "./frontend"
          fail-build: false
          severity-cutoff: critical
          output-format: json

      - name: Scan Backend Dependencies
        id: grype-backend
        uses: anchore/scan-action@v3
        continue-on-error: true
        with:
          path: "./backend"
          fail-build: false
          severity-cutoff: critical
          output-format: json

      - name: Parse Vulnerability Results
        id: grype
        run: |
          # Count vulnerabilities from both scans
          CRITICAL=0
          HIGH=0

          # Parse frontend results
          if [ -f "${{ steps.grype-frontend.outputs.sarif }}" ]; then
            FRONTEND_CRITICAL=$(cat "${{ steps.grype-frontend.outputs.sarif }}" | jq '[.runs[].results[] | select(.level == "error")] | length' 2>/dev/null || echo 0)
            FRONTEND_HIGH=$(cat "${{ steps.grype-frontend.outputs.sarif }}" | jq '[.runs[].results[] | select(.level == "warning")] | length' 2>/dev/null || echo 0)
            CRITICAL=$((CRITICAL + FRONTEND_CRITICAL))
            HIGH=$((HIGH + FRONTEND_HIGH))
          fi

          # Parse backend results
          if [ -f "${{ steps.grype-backend.outputs.sarif }}" ]; then
            BACKEND_CRITICAL=$(cat "${{ steps.grype-backend.outputs.sarif }}" | jq '[.runs[].results[] | select(.level == "error")] | length' 2>/dev/null || echo 0)
            BACKEND_HIGH=$(cat "${{ steps.grype-backend.outputs.sarif }}" | jq '[.runs[].results[] | select(.level == "warning")] | length' 2>/dev/null || echo 0)
            CRITICAL=$((CRITICAL + BACKEND_CRITICAL))
            HIGH=$((HIGH + BACKEND_HIGH))
          fi

          echo "critical_count=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high_count=${HIGH}" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ]; then
            echo "vulnerabilities=critical" >> $GITHUB_OUTPUT
          elif [ "$HIGH" -gt 0 ]; then
            echo "vulnerabilities=high" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities=none" >> $GITHUB_OUTPUT
          fi

          echo "### ðŸ›¡ï¸ Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| CRITICAL | ${CRITICAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| HIGH | ${HIGH} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: ${{ steps.grype-frontend.outputs.sarif }}
          category: "grype-frontend"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPENDENCY CHECK - License Compliance
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  license-check:
    name: "ðŸ“œ License Compliance"
    runs-on: ubuntu-latest
    outputs:
      compliance: ${{ steps.check.outputs.compliance }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Frontend Licenses
        id: check
        working-directory: ./frontend
        continue-on-error: true
        run: |
          npm install --legacy-peer-deps 2>/dev/null || true
          npx license-checker --summary --production 2>/dev/null || echo "License check skipped"

          # Check for problematic licenses
          PROBLEMATIC=$(npx license-checker --production --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;0BSD;CC0-1.0;Unlicense' 2>/dev/null || echo "")

          if [ -z "$PROBLEMATIC" ]; then
            echo "compliance=passed" >> $GITHUB_OUTPUT
            echo "### âœ… License Compliance Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "compliance=warning" >> $GITHUB_OUTPUT
            echo "### âš ï¸ License Review Needed" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # QUALITY GATE EVALUATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality-gate:
    name: "ðŸš¦ Quality Gate"
    runs-on: ubuntu-latest
    needs: [secrets-scan, sast-sonarqube, sca-grype, license-check]
    if: always()
    outputs:
      gate_passed: ${{ steps.evaluate.outputs.gate_passed }}
      gate_status: ${{ steps.evaluate.outputs.gate_status }}

    steps:
      - name: Evaluate Quality Gate
        id: evaluate
        env:
          SECRETS_FOUND: ${{ needs.secrets-scan.outputs.secrets_found }}
          SONAR_GATE: ${{ needs.sast-sonarqube.outputs.quality_gate }}
          CRITICAL_VULNS: ${{ needs.sca-grype.outputs.critical_count }}
          HIGH_VULNS: ${{ needs.sca-grype.outputs.high_count }}
          LICENSE_CHECK: ${{ needs.license-check.outputs.compliance }}
          FAIL_ON_CRITICAL: ${{ inputs.fail_on_critical }}
        run: |
          PASSED=true
          STATUS="âœ… All checks passed"

          # Check for secrets (always fails)
          if [ "$SECRETS_FOUND" = "true" ]; then
            PASSED=false
            STATUS="âŒ BLOCKED: Secrets detected in code"
          fi

          # Check for critical vulnerabilities
          if [ "${FAIL_ON_CRITICAL:-true}" = "true" ] && [ "${CRITICAL_VULNS:-0}" -gt 0 ]; then
            PASSED=false
            STATUS="âŒ BLOCKED: ${CRITICAL_VULNS} critical vulnerabilities"
          fi

          # SonarQube gate (warning only if not configured)
          if [ "$SONAR_GATE" = "failed" ]; then
            PASSED=false
            STATUS="âŒ BLOCKED: SonarQube quality gate failed"
          fi

          echo "gate_passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "gate_status=${STATUS}" >> $GITHUB_OUTPUT

          echo "## ðŸš¦ Quality Gate Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PASSED" = "true" ]; then
            echo "### âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets Detection | $([[ \"$SECRETS_FOUND\" = \"true\" ]] && echo 'âŒ Found' || echo 'âœ… Clear') |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarQube | $([[ \"$SONAR_GATE\" = \"passed\" ]] && echo 'âœ… Passed' || ([[ \"$SONAR_GATE\" = \"skipped\" ]] && echo 'â­ï¸ Skipped' || echo 'âŒ Failed')) |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical Vulns | ${CRITICAL_VULNS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| High Vulns | ${HIGH_VULNS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | $([[ \"$LICENSE_CHECK\" = \"passed\" ]] && echo 'âœ… Compliant' || echo 'âš ï¸ Review') |" >> $GITHUB_STEP_SUMMARY

          if [ "$PASSED" != "true" ]; then
            echo ""
            echo "### ðŸ›‘ Build Blocked"
            echo "Fix the issues above before the build can proceed."
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TRIGGER BUILD (if gate passed)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  trigger-build:
    name: "ðŸš€ Trigger Build"
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: |
      always() &&
      needs.quality-gate.outputs.gate_passed == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'

    steps:
      - name: Trigger CI Build
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "### ðŸš€ Triggering CI Build & Deploy" >> $GITHUB_STEP_SUMMARY
          echo "Quality gate passed - initiating build pipeline" >> $GITHUB_STEP_SUMMARY

          # The build will be triggered automatically by the push event
          # This job just confirms the gate passed
          echo "âœ… Build pipeline authorized to proceed"
