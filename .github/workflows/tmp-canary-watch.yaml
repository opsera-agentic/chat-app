# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CANARY WATCH - Live monitoring dashboard for canary deployments              â•‘
# â•‘  Generated by Code-to-Cloud v0.6 - Powered by Opsera                          â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ“Š Canary Watch Dashboard"

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: "How long to monitor (minutes)"
        required: false
        default: "10"
      environment:
        description: "Environment to monitor"
        required: false
        default: "qa"

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  APP_NAME: chat-app

jobs:
  watch:
    name: "ðŸ“Š Live Canary Dashboard"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Tools
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          curl -sLO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Live Canary Dashboard
        run: |
          DURATION=${{ inputs.duration_minutes || '10' }}
          CHECKS=$((DURATION * 4))
          NS="${{ env.APP_NAME }}-${{ inputs.environment || 'qa' }}"
          
          echo "# ðŸŽ¯ Canary Deployment Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application:** ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'qa' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring for $DURATION minutes** ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get rollout names
          FRONTEND_ROLLOUT="frontend-rollout"
          BACKEND_ROLLOUT="backend-rollout"
          
          # Check if rollouts exist
          echo "## ðŸ“‹ Rollout Status" >> $GITHUB_STEP_SUMMARY
          
          for ROLLOUT in $FRONTEND_ROLLOUT $BACKEND_ROLLOUT; do
            if kubectl get rollout $ROLLOUT -n $NS &>/dev/null; then
              IMAGE=$(kubectl get rollout $ROLLOUT -n $NS -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null | cut -d: -f2)
              echo "| $ROLLOUT | \`$IMAGE\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ Progress Timeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          PREV_PHASE=""
          PREV_WEIGHT=""
          
          for i in $(seq 1 $CHECKS); do
            # Check frontend rollout (primary)
            PHASE=$(kubectl get rollout $FRONTEND_ROLLOUT -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            STEP=$(kubectl get rollout $FRONTEND_ROLLOUT -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")
            WEIGHT=$(kubectl get rollout $FRONTEND_ROLLOUT -n $NS -o jsonpath='{.status.canary.weight}' 2>/dev/null || echo "0")
            
            if [ "$PHASE" != "$PREV_PHASE" ] || [ "$WEIGHT" != "$PREV_WEIGHT" ]; then
              TIME=$(date -u '+%H:%M:%S')
              
              case "$PHASE" in
                Healthy) EMOJI="âœ…" ;;
                Progressing) EMOJI="ðŸ”„" ;;
                Paused) EMOJI="â¸ï¸" ;;
                Degraded) EMOJI="âŒ" ;;
                *) EMOJI="â³" ;;
              esac
              
              # Progress bar
              PCT=$((WEIGHT))
              FILLED=$((PCT / 10))
              EMPTY=$((10 - FILLED))
              BAR=""
              for j in $(seq 1 $FILLED); do BAR="${BAR}â–ˆ"; done
              for j in $(seq 1 $EMPTY); do BAR="${BAR}â–‘"; done
              
              echo "### $EMOJI $TIME - $PHASE" >> $GITHUB_STEP_SUMMARY
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Traffic Weight | **${WEIGHT}%** \`$BAR\` |" >> $GITHUB_STEP_SUMMARY
              echo "| Step | $STEP |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Analysis status
              LATEST_AR=$(kubectl get analysisruns -n $NS --sort-by='.metadata.creationTimestamp' -o name 2>/dev/null | tail -1)
              if [ -n "$LATEST_AR" ]; then
                AR_PHASE=$(kubectl get $LATEST_AR -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
                echo "**Analysis:** $AR_PHASE" >> $GITHUB_STEP_SUMMARY
              fi
              
              echo "---" >> $GITHUB_STEP_SUMMARY
              
              PREV_PHASE="$PHASE"
              PREV_WEIGHT="$WEIGHT"
            fi
            
            # Exit conditions
            if [ "$PHASE" = "Healthy" ]; then
              echo "## ðŸŽ‰ Canary Complete!" >> $GITHUB_STEP_SUMMARY
              echo "All traffic now on new version." >> $GITHUB_STEP_SUMMARY
              break
            fi
            
            if [ "$PHASE" = "Degraded" ]; then
              echo "## âŒ Canary Failed!" >> $GITHUB_STEP_SUMMARY
              echo "Automatic rollback triggered." >> $GITHUB_STEP_SUMMARY
              kubectl-argo-rollouts get rollout $FRONTEND_ROLLOUT -n $NS 2>&1 || true
              exit 1
            fi
            
            sleep 15
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Final Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl-argo-rollouts get rollout $FRONTEND_ROLLOUT -n $NS 2>&1 || echo "Rollout not found"
          echo '```' >> $GITHUB_STEP_SUMMARY
