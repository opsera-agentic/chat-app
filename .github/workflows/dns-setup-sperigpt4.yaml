# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DNS SETUP - sperigpt4
# Code-to-Cloud Enterprise v1.7.3
#
# RULE 94: DNS setup as separate one-time workflow (not in CI/CD)
# Creates Route53 CNAME record pointing to NGINX Ingress Load Balancer
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸŒ sperigpt4: DNS Setup"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to setup DNS for'
        type: choice
        options: [dev]
        default: dev
      confirm:
        description: 'â˜‘ï¸ I confirm this DNS setup'
        type: boolean
        default: false
        required: true

env:
  APP_NAME: sperigpt4
  TENANT: opsera
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  DOMAIN: agent.opsera.dev

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CHECK DNS STATUS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  check-dns:
    name: "ğŸ” Check DNS Status"
    runs-on: ubuntu-latest
    if: inputs.confirm == true
    outputs:
      needs_setup: ${{ steps.check.outputs.needs_setup }}
      fqdn: ${{ steps.vars.outputs.fqdn }}
    steps:
      - name: Calculate Variables
        id: vars
        run: |
          FQDN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.${{ env.DOMAIN }}"
          echo "fqdn=${FQDN}" >> $GITHUB_OUTPUT
          echo "Target FQDN: ${FQDN}"

      - name: Check if DNS Already Configured
        id: check
        run: |
          FQDN="${{ steps.vars.outputs.fqdn }}"

          echo "Checking DNS for: ${FQDN}"

          # Check if DNS already resolves
          RESOLVED=$(dig +short ${FQDN} @8.8.8.8 | head -1 || echo "")

          if [ -n "$RESOLVED" ]; then
            echo "âœ… DNS already configured: ${RESOLVED}"
            echo "needs_setup=false" >> $GITHUB_OUTPUT

            # RULE 91: Verify region
            if echo "$RESOLVED" | grep -q "us-west-2"; then
              echo "âœ… DNS points to correct region (us-west-2)"
            else
              echo "âš ï¸ DNS may point to different region"
              echo "Current target: ${RESOLVED}"
            fi
          else
            echo "ğŸ“ DNS not configured - setup needed"
            echo "needs_setup=true" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CONFIGURE DNS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  configure-dns:
    name: "ğŸŒ Configure Route53 DNS"
    needs: [check-dns]
    if: needs.check-dns.outputs.needs_setup == 'true'
    runs-on: ubuntu-latest
    outputs:
      dns_automated: ${{ steps.create-dns.outputs.dns_automated }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Get Load Balancer Hostname
        id: lb
        run: |
          # Check if ingress-nginx service exists
          if ! kubectl get svc ingress-nginx-controller -n ingress-nginx &>/dev/null; then
            echo "âŒ NGINX Ingress Controller not found"
            echo "Run bootstrap workflow first!"
            exit 1
          fi

          LB_HOSTNAME=$(kubectl get svc ingress-nginx-controller -n ingress-nginx \
            -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')

          if [ -z "$LB_HOSTNAME" ]; then
            echo "âŒ Load Balancer not ready"
            exit 1
          fi

          echo "Load Balancer: ${LB_HOSTNAME}"
          echo "hostname=${LB_HOSTNAME}" >> $GITHUB_OUTPUT

          # RULE 91: Verify region
          if echo "$LB_HOSTNAME" | grep -q "us-west-2"; then
            echo "âœ… Load Balancer in correct region (us-west-2)"
          else
            echo "âš ï¸ Load Balancer may be in different region"
          fi

      - name: Discover Hosted Zone
        id: zone
        run: |
          # Find hosted zone for domain
          ZONE_ID=$(aws route53 list-hosted-zones \
            --query "HostedZones[?ends_with(Name, '${{ env.DOMAIN }}.')].Id" \
            --output text | cut -d'/' -f3 | head -1)

          if [ -z "$ZONE_ID" ]; then
            echo "âŒ Hosted zone not found for: ${{ env.DOMAIN }}"
            echo "Available zones:"
            aws route53 list-hosted-zones --query 'HostedZones[*].[Name,Id]' --output table
            exit 1
          fi

          echo "Hosted Zone ID: ${ZONE_ID}"
          echo "zone_id=${ZONE_ID}" >> $GITHUB_OUTPUT

      - name: Create DNS Record (RULE 56: with fallback)
        id: create-dns
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"
          LB_HOSTNAME="${{ steps.lb.outputs.hostname }}"
          ZONE_ID="${{ steps.zone.outputs.zone_id }}"

          # Prepare change batch
          cat > /tmp/dns-change.json <<EOF
          {
            "Changes": [{
              "Action": "UPSERT",
              "ResourceRecordSet": {
                "Name": "${FQDN}",
                "Type": "CNAME",
                "TTL": 300,
                "ResourceRecords": [{"Value": "${LB_HOSTNAME}"}]
              }
            }]
          }
          EOF

          echo "DNS Change Batch:"
          cat /tmp/dns-change.json

          # Try DNS automation with error handling (RULE 56)
          set +e
          CHANGE_OUTPUT=$(aws route53 change-resource-record-sets \
            --hosted-zone-id $ZONE_ID \
            --change-batch file:///tmp/dns-change.json \
            --query 'ChangeInfo.Id' \
            --output text 2>&1)
          DNS_EXIT_CODE=$?
          set -e

          if [ $DNS_EXIT_CODE -eq 0 ]; then
            echo "âœ… DNS Record Created: ${CHANGE_OUTPUT}"
            echo "dns_automated=true" >> $GITHUB_OUTPUT

            echo "### âœ… DNS Record Created" >> $GITHUB_STEP_SUMMARY
            echo "- FQDN: \`${FQDN}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Target: \`${LB_HOSTNAME}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Change ID: \`${CHANGE_OUTPUT}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ DNS automation failed"
            echo "Error: ${CHANGE_OUTPUT}"
            echo "dns_automated=false" >> $GITHUB_OUTPUT

            echo "### âš ï¸ DNS Automation Failed - Manual Setup Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Hosted Zone | \`${{ env.DOMAIN }}\` (${ZONE_ID}) |" >> $GITHUB_STEP_SUMMARY
            echo "| Record Name | \`${FQDN}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Type | CNAME |" >> $GITHUB_STEP_SUMMARY
            echo "| Value | \`${LB_HOSTNAME}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| TTL | 300 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error:** \`${CHANGE_OUTPUT}\`" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # WAIT FOR PROPAGATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  wait-propagation:
    name: "â³ Wait for DNS Propagation"
    needs: [check-dns, configure-dns]
    if: always() && (needs.configure-dns.outputs.dns_automated == 'true' || needs.check-dns.outputs.needs_setup == 'false')
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS Propagation
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"

          echo "Waiting for DNS propagation: ${FQDN}"

          for i in {1..30}; do
            RESOLVED=$(dig +short ${FQDN} @8.8.8.8 | head -1 || echo "")

            if [ -n "$RESOLVED" ]; then
              echo "âœ… DNS propagated!"
              echo "  ${FQDN} â†’ ${RESOLVED}"

              echo "### âœ… DNS Propagated" >> $GITHUB_STEP_SUMMARY
              echo "- FQDN: \`${FQDN}\`" >> $GITHUB_STEP_SUMMARY
              echo "- Resolves to: \`${RESOLVED}\`" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            echo "Attempt $i/30 - waiting..."
            sleep 10
          done

          echo "âš ï¸ DNS not yet fully propagated - may need more time"
          echo "Check manually: dig ${FQDN} @8.8.8.8"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ğŸ“‹ Summary"
    needs: [check-dns, configure-dns, wait-propagation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"

          cat << EOF >> $GITHUB_STEP_SUMMARY

          ---

          ## ğŸ‰ DNS Setup Complete

          ### Access Your Application
          - **URL**: https://${FQDN}
          - **Environment**: ${{ inputs.environment }}

          ### Verification Commands
          \`\`\`bash
          # Check DNS resolution
          dig +short ${FQDN}

          # Test HTTPS (after cert issuance)
          curl -I https://${FQDN}
          \`\`\`

          ### Notes
          - DNS typically propagates in 2-5 minutes
          - TLS certificate will be issued automatically by cert-manager
          - First certificate issuance may take 2-3 minutes

          EOF
