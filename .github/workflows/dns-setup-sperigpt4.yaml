# DNS SETUP - sperigpt4
# Code-to-Cloud Enterprise v1.7.3
# RULE 94: DNS setup as separate one-time workflow (not in CI/CD)

name: sperigpt4 DNS Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to setup DNS for
        type: choice
        options:
          - dev
        default: dev
      confirm:
        description: Confirm this DNS setup
        type: boolean
        default: false
        required: true

env:
  APP_NAME: sperigpt4
  TENANT: opsera
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  DOMAIN: agent.opsera.dev

permissions:
  contents: read
  id-token: write

jobs:
  check-dns:
    name: Check DNS Status
    runs-on: ubuntu-latest
    if: inputs.confirm == true
    outputs:
      needs_setup: ${{ steps.check.outputs.needs_setup }}
      fqdn: ${{ steps.vars.outputs.fqdn }}
    steps:
      - name: Calculate Variables
        id: vars
        run: |
          FQDN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.${{ env.DOMAIN }}"
          echo "fqdn=${FQDN}" >> $GITHUB_OUTPUT
          echo "Target FQDN: ${FQDN}"

      - name: Check if DNS Already Configured
        id: check
        run: |
          FQDN="${{ steps.vars.outputs.fqdn }}"
          echo "Checking DNS for: ${FQDN}"
          RESOLVED=$(dig +short ${FQDN} @8.8.8.8 | head -1 || echo "")
          if [ -n "$RESOLVED" ]; then
            echo "DNS already configured: ${RESOLVED}"
            echo "needs_setup=false" >> $GITHUB_OUTPUT
          else
            echo "DNS not configured - setup needed"
            echo "needs_setup=true" >> $GITHUB_OUTPUT
          fi

  configure-dns:
    name: Configure Route53 DNS
    needs: [check-dns]
    if: needs.check-dns.outputs.needs_setup == 'true'
    runs-on: ubuntu-latest
    outputs:
      dns_automated: ${{ steps.create-dns.outputs.dns_automated }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Get Load Balancer Hostname
        id: lb
        run: |
          if ! kubectl get svc ingress-nginx-controller -n ingress-nginx; then
            echo "NGINX Ingress Controller not found"
            exit 1
          fi
          LB_HOSTNAME=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ -z "$LB_HOSTNAME" ]; then
            echo "Load Balancer not ready"
            exit 1
          fi
          echo "Load Balancer: ${LB_HOSTNAME}"
          echo "hostname=${LB_HOSTNAME}" >> $GITHUB_OUTPUT

      - name: Discover Hosted Zone
        id: zone
        run: |
          ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?ends_with(Name, '${{ env.DOMAIN }}.')].Id" --output text | cut -d'/' -f3 | head -1)
          if [ -z "$ZONE_ID" ]; then
            echo "Hosted zone not found for: ${{ env.DOMAIN }}"
            aws route53 list-hosted-zones --query 'HostedZones[*].[Name,Id]' --output table
            exit 1
          fi
          echo "Hosted Zone ID: ${ZONE_ID}"
          echo "zone_id=${ZONE_ID}" >> $GITHUB_OUTPUT

      - name: Create DNS Record
        id: create-dns
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"
          LB_HOSTNAME="${{ steps.lb.outputs.hostname }}"
          ZONE_ID="${{ steps.zone.outputs.zone_id }}"

          cat > /tmp/dns-change.json <<EOF
          {
            "Changes": [{
              "Action": "UPSERT",
              "ResourceRecordSet": {
                "Name": "${FQDN}",
                "Type": "CNAME",
                "TTL": 300,
                "ResourceRecords": [{"Value": "${LB_HOSTNAME}"}]
              }
            }]
          }
          EOF

          echo "DNS Change Batch:"
          cat /tmp/dns-change.json

          set +e
          CHANGE_OUTPUT=$(aws route53 change-resource-record-sets --hosted-zone-id $ZONE_ID --change-batch file:///tmp/dns-change.json --query 'ChangeInfo.Id' --output text 2>&1)
          DNS_EXIT_CODE=$?
          set -e

          if [ $DNS_EXIT_CODE -eq 0 ]; then
            echo "DNS Record Created: ${CHANGE_OUTPUT}"
            echo "dns_automated=true" >> $GITHUB_OUTPUT
            echo "### DNS Record Created" >> $GITHUB_STEP_SUMMARY
            echo "- FQDN: ${FQDN}" >> $GITHUB_STEP_SUMMARY
            echo "- Target: ${LB_HOSTNAME}" >> $GITHUB_STEP_SUMMARY
          else
            echo "DNS automation failed: ${CHANGE_OUTPUT}"
            echo "dns_automated=false" >> $GITHUB_OUTPUT
            echo "### DNS Setup Failed - Manual Required" >> $GITHUB_STEP_SUMMARY
            echo "FQDN: ${FQDN}" >> $GITHUB_STEP_SUMMARY
            echo "Target: ${LB_HOSTNAME}" >> $GITHUB_STEP_SUMMARY
          fi

  wait-propagation:
    name: Wait for DNS Propagation
    needs: [check-dns, configure-dns]
    if: always() && (needs.configure-dns.outputs.dns_automated == 'true' || needs.check-dns.outputs.needs_setup == 'false')
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS Propagation
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"
          echo "Waiting for DNS propagation: ${FQDN}"
          for i in {1..30}; do
            RESOLVED=$(dig +short ${FQDN} @8.8.8.8 | head -1 || echo "")
            if [ -n "$RESOLVED" ]; then
              echo "DNS propagated: ${FQDN} -> ${RESOLVED}"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 10
          done
          echo "DNS not yet propagated - may need more time"

  summary:
    name: Summary
    needs: [check-dns, configure-dns, wait-propagation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          FQDN="${{ needs.check-dns.outputs.fqdn }}"
          echo "## DNS Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "URL: https://${FQDN}" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
