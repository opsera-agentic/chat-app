# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BOOTSTRAP WORKFLOW - sperichatgpt2
# Sets up ECR, ArgoCD app, and initial infrastructure
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "sperichatgpt2: 00 Bootstrap Infrastructure"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap'
        type: choice
        options: [dev]
        default: 'dev'
      confirm:
        description: 'I confirm bootstrap execution'
        type: boolean
        default: false
        required: true

env:
  APP_NAME: sperichatgpt2
  TENANT: opseratest
  AWS_REGION: us-east-1
  EKS_HUB_CLUSTER: argocd-use1
  EKS_SPOKE_CLUSTER: opseratest-use1-np
  DOMAIN: agent.opsera.dev

permissions:
  contents: write
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VALIDATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: "âœ… Validate"
    runs-on: ubuntu-latest
    if: inputs.confirm == true
    outputs:
      account_id: ${{ steps.aws.outputs.account_id }}
      ecr_backend: ${{ steps.ecr.outputs.backend }}
      ecr_frontend: ${{ steps.ecr.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "### AWS Account: $ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY

      - name: Calculate ECR URIs
        id: ecr
        run: |
          ACCOUNT_ID="${{ steps.aws.outputs.account_id }}"
          BACKEND="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TENANT }}/${{ env.APP_NAME }}-backend"
          FRONTEND="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TENANT }}/${{ env.APP_NAME }}-frontend"
          echo "backend=$BACKEND" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ECR REPOSITORIES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-ecr:
    name: "ğŸ“¦ Create ECR Repositories"
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create Backend ECR Repository
        run: |
          REPO="${{ env.TENANT }}/${{ env.APP_NAME }}-backend"
          if aws ecr describe-repositories --repository-names "$REPO" 2>/dev/null; then
            echo "âœ… Backend ECR already exists: $REPO"
          else
            aws ecr create-repository \
              --repository-name "$REPO" \
              --image-scanning-configuration scanOnPush=true \
              --tags Key=tenant,Value=${{ env.TENANT }} Key=app,Value=${{ env.APP_NAME }}
            echo "âœ… Created Backend ECR: $REPO"
          fi

      - name: Create Frontend ECR Repository
        run: |
          REPO="${{ env.TENANT }}/${{ env.APP_NAME }}-frontend"
          if aws ecr describe-repositories --repository-names "$REPO" 2>/dev/null; then
            echo "âœ… Frontend ECR already exists: $REPO"
          else
            aws ecr create-repository \
              --repository-name "$REPO" \
              --image-scanning-configuration scanOnPush=true \
              --tags Key=tenant,Value=${{ env.TENANT }} Key=app,Value=${{ env.APP_NAME }}
            echo "âœ… Created Frontend ECR: $REPO"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UPDATE KUSTOMIZATION WITH ECR URLS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: "ğŸ“ Update Manifests"
    needs: [validate, create-ecr]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update Kustomization with ECR URLs
        run: |
          ACCOUNT_ID="${{ needs.validate.outputs.account_id }}"
          BACKEND_ECR="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TENANT }}/${{ env.APP_NAME }}-backend"
          FRONTEND_ECR="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.TENANT }}/${{ env.APP_NAME }}-frontend"

          # Update dev overlay
          KUST_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${{ inputs.environment }}/kustomization.yaml"

          sed -i "s|PLACEHOLDER_ECR_BACKEND|${BACKEND_ECR}|g" "$KUST_FILE"
          sed -i "s|PLACEHOLDER_ECR_FRONTEND|${FRONTEND_ECR}|g" "$KUST_FILE"

          echo "âœ… Updated kustomization.yaml with ECR URLs"
          cat "$KUST_FILE"

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .opsera-${{ env.APP_NAME }}/

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update ECR URLs for ${{ env.APP_NAME }} [skip ci]"
            git pull --rebase origin main
            git push origin main
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ARGOCD REPO SECRET
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-argocd-secret:
    name: "ğŸ” Create ArgoCD Repo Secret"
    needs: [validate, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Create ArgoCD Repository Secret
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # RULE 63: Create ArgoCD repository secret with GH_PAT
          kubectl create secret generic repo-${{ env.APP_NAME }} -n argocd \
            --from-literal=type=git \
            --from-literal=url="https://github.com/${{ github.repository }}" \
            --from-literal=username=git \
            --from-literal=password="${GH_PAT}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl label secret repo-${{ env.APP_NAME }} -n argocd \
            argocd.argoproj.io/secret-type=repository --overwrite

          echo "âœ… ArgoCD repository secret created"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # APPLY ARGOCD APPLICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  apply-argocd-app:
    name: "ğŸš€ Apply ArgoCD Application"
    needs: [validate, create-argocd-secret]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Apply ArgoCD Application
        run: |
          APP_FILE=".opsera-${{ env.APP_NAME }}/argocd/${{ inputs.environment }}/application.yaml"

          if [ ! -f "$APP_FILE" ]; then
            echo "âŒ Application file not found: $APP_FILE"
            exit 1
          fi

          kubectl apply -f "$APP_FILE"
          echo "âœ… ArgoCD Application applied"

      - name: Verify Application Created
        run: |
          sleep 5
          kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o wide

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CREATE ECR PULL SECRET ON SPOKE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-ecr-secret:
    name: "ğŸ”‘ Create ECR Pull Secret"
    needs: [validate, apply-argocd-app]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Spoke Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Create Namespace
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Create ECR Pull Secret
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          ACCOUNT_ID="${{ needs.validate.outputs.account_id }}"

          # Get ECR login password
          ECR_PASSWORD=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          ECR_SERVER="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

          # Create docker-registry secret
          kubectl create secret docker-registry ecr-secret \
            --docker-server=$ECR_SERVER \
            --docker-username=AWS \
            --docker-password=$ECR_PASSWORD \
            -n $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "âœ… ECR pull secret created in namespace: $NAMESPACE"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ğŸ“‹ Summary"
    needs: [validate, create-ecr, update-manifests, apply-argocd-app, create-ecr-secret]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # ğŸ‰ Bootstrap Complete: ${{ env.APP_NAME }}

          ## Configuration
          | Setting | Value |
          |---------|-------|
          | **App Name** | \`${{ env.APP_NAME }}\` |
          | **Tenant** | \`${{ env.TENANT }}\` |
          | **Environment** | \`${{ inputs.environment }}\` |
          | **Region** | \`${{ env.AWS_REGION }}\` |
          | **Spoke Cluster** | \`${{ env.EKS_SPOKE_CLUSTER }}\` |
          | **Hub Cluster** | \`${{ env.EKS_HUB_CLUSTER }}\` |

          ## Resources Created
          - âœ… ECR Repository: \`${{ env.TENANT }}/${{ env.APP_NAME }}-backend\`
          - âœ… ECR Repository: \`${{ env.TENANT }}/${{ env.APP_NAME }}-frontend\`
          - âœ… ArgoCD Application: \`${{ env.APP_NAME }}-${{ inputs.environment }}\`
          - âœ… ECR Pull Secret in namespace

          ## Next Steps
          1. **Push code to main** to trigger CI/CD:
             \`\`\`bash
             git add . && git commit -m "feat: initial deployment" && git push origin main
             \`\`\`

          2. **Or run CI/CD manually**:
             \`\`\`bash
             gh workflow run "sperichatgpt2: 10 CI Build & Deploy" -f environment=dev
             \`\`\`

          ## Expected URL
          \`https://${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}.${{ env.DOMAIN }}\`
          EOF
