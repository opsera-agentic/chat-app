# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  HTTPS SETUP - Configure TLS certificates for sperigpt-01                    â•‘
# â•‘  Code-to-Cloud v0.6 - Powered by Opsera                                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”’ sperigpt-01: 30 HTTPS Setup"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - all
        default: 'all'

env:
  AWS_REGION: us-west-2
  TENANT: opsera
  APP_NAME: sperigpt-01

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DISCOVER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  discover:
    name: "ðŸ” Discover Infrastructure"
    runs-on: ubuntu-latest
    outputs:
      spoke_cluster: ${{ steps.discover.outputs.spoke_cluster }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discover Spoke Cluster
        id: discover
        run: |
          case "${{ env.AWS_REGION }}" in
            us-west-2) REGION_SHORT="usw2" ;;
            us-east-1) REGION_SHORT="use1" ;;
            *) REGION_SHORT=$(echo "${{ env.AWS_REGION }}" | sed 's/-//g' | cut -c1-4) ;;
          esac

          SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-np"
          echo "spoke_cluster=${SPOKE_CLUSTER}" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFY CERT-MANAGER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-cert-manager:
    name: "ðŸ“œ Verify cert-manager"
    runs-on: ubuntu-latest
    needs: [discover]

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Verify cert-manager Installation
        run: |
          aws eks update-kubeconfig --name ${{ needs.discover.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}

          echo "### ðŸ“œ cert-manager Status" >> $GITHUB_STEP_SUMMARY

          if kubectl get namespace cert-manager &>/dev/null; then
            echo "- âœ… cert-manager namespace exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Installing cert-manager..." >> $GITHUB_STEP_SUMMARY
            kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
            sleep 60
            echo "- âœ… cert-manager installed" >> $GITHUB_STEP_SUMMARY
          fi

          # Wait for cert-manager pods
          kubectl wait --for=condition=Ready pods -l app=cert-manager -n cert-manager --timeout=120s || true
          kubectl wait --for=condition=Ready pods -l app=webhook -n cert-manager --timeout=120s || true

          # Check for ClusterIssuer
          if kubectl get clusterissuer letsencrypt-prod &>/dev/null; then
            echo "- âœ… letsencrypt-prod ClusterIssuer exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Creating letsencrypt-prod ClusterIssuer..." >> $GITHUB_STEP_SUMMARY
            cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: devops@opsera.io
              privateKeySecretRef:
                name: letsencrypt-prod
              solvers:
                - http01:
                    ingress:
                      class: nginx
          EOF
            echo "- âœ… letsencrypt-prod ClusterIssuer created" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SETUP DNS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup-dns:
    name: "ðŸŒ Setup DNS (${{ matrix.environment }})"
    runs-on: ubuntu-latest
    needs: [discover, verify-cert-manager]
    strategy:
      matrix:
        environment: ${{ fromJSON(inputs.environment == 'all' && '["dev", "qa", "staging"]' || format('["{0}"]', inputs.environment)) }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Get Ingress Load Balancer
        id: ingress
        run: |
          aws eks update-kubeconfig --name ${{ needs.discover.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${{ matrix.environment }}"
          SUBDOMAIN="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ matrix.environment }}.agent.opsera.dev"

          echo "### ðŸŒ DNS Setup: ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY

          # Get NGINX ingress controller load balancer
          LB_HOSTNAME=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

          if [ -z "$LB_HOSTNAME" ]; then
            echo "- âš ï¸ Load balancer not ready yet" >> $GITHUB_STEP_SUMMARY
            echo "lb_hostname=" >> $GITHUB_OUTPUT
          else
            echo "lb_hostname=${LB_HOSTNAME}" >> $GITHUB_OUTPUT
            echo "- âœ… Load Balancer: \`${LB_HOSTNAME}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT

      - name: Create Route53 DNS Record
        if: steps.ingress.outputs.lb_hostname != ''
        run: |
          SUBDOMAIN="${{ steps.ingress.outputs.subdomain }}"
          LB_HOSTNAME="${{ steps.ingress.outputs.lb_hostname }}"

          # Get hosted zone ID
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name "agent.opsera.dev" \
            --query "HostedZones[?Name=='agent.opsera.dev.'].Id" \
            --output text | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "- âŒ Hosted zone not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Create CNAME record
          aws route53 change-resource-record-sets \
            --hosted-zone-id "$HOSTED_ZONE_ID" \
            --change-batch '{
              "Changes": [{
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "'"${SUBDOMAIN}"'",
                  "Type": "CNAME",
                  "TTL": 300,
                  "ResourceRecords": [{"Value": "'"${LB_HOSTNAME}"'"}]
                }
              }]
            }'

          echo "- âœ… DNS: \`${SUBDOMAIN}\` â†’ \`${LB_HOSTNAME}\`" >> $GITHUB_STEP_SUMMARY

      - name: Create Preview DNS (Staging only)
        if: matrix.environment == 'staging' && steps.ingress.outputs.lb_hostname != ''
        run: |
          LB_HOSTNAME="${{ steps.ingress.outputs.lb_hostname }}"
          PREVIEW_SUBDOMAIN="preview.${{ env.TENANT }}-${{ env.APP_NAME }}-staging.agent.opsera.dev"

          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones-by-name \
            --dns-name "agent.opsera.dev" \
            --query "HostedZones[?Name=='agent.opsera.dev.'].Id" \
            --output text | sed 's|/hostedzone/||')

          aws route53 change-resource-record-sets \
            --hosted-zone-id "$HOSTED_ZONE_ID" \
            --change-batch '{
              "Changes": [{
                "Action": "UPSERT",
                "ResourceRecordSet": {
                  "Name": "'"${PREVIEW_SUBDOMAIN}"'",
                  "Type": "CNAME",
                  "TTL": 300,
                  "ResourceRecords": [{"Value": "'"${LB_HOSTNAME}"'"}]
                }
              }]
            }'

          echo "- âœ… Preview DNS: \`${PREVIEW_SUBDOMAIN}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFY CERTIFICATES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-certs:
    name: "ðŸ”’ Verify Certificates"
    runs-on: ubuntu-latest
    needs: [discover, setup-dns]

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Check Certificate Status
        run: |
          aws eks update-kubeconfig --name ${{ needs.discover.outputs.spoke_cluster }} --region ${{ env.AWS_REGION }}

          echo "### ðŸ”’ Certificate Status" >> $GITHUB_STEP_SUMMARY

          for ENV in dev qa staging; do
            NAMESPACE="${{ env.APP_NAME }}-${ENV}"
            if kubectl get namespace $NAMESPACE &>/dev/null; then
              echo "#### ${ENV}" >> $GITHUB_STEP_SUMMARY
              kubectl get certificates -n $NAMESPACE -o wide 2>/dev/null | tee -a $GITHUB_STEP_SUMMARY || echo "No certificates yet" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Certificates may take 2-5 minutes to be issued by Let's Encrypt" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“‹ HTTPS Summary"
    runs-on: ubuntu-latest
    needs: [verify-certs]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ”’ HTTPS Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | URL | Strategy |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | https://opsera-sperigpt-01-dev.agent.opsera.dev | Direct |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | https://opsera-sperigpt-01-qa.agent.opsera.dev | Canary |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | https://opsera-sperigpt-01-staging.agent.opsera.dev | Blue-Green |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Preview | https://preview.opsera-sperigpt-01-staging.agent.opsera.dev | Blue-Green |" >> $GITHUB_STEP_SUMMARY
