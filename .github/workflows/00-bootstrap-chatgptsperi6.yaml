# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# Bootstrap Infrastructure - chatgptsperi6
# Generated by Opsera Code-to-Cloud Enterprise v1.7.3
# One-time setup: ArgoCD app, ECR repos, namespace, secrets
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

name: "chatgptsperi6: 00 Bootstrap"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap'
        type: choice
        options: [dev]
        default: 'dev'
      confirm:
        description: 'Confirm bootstrap'
        type: boolean
        default: false
        required: true

env:
  APP_NAME: chatgptsperi6
  AWS_REGION: us-west-2
  EKS_CLUSTER: opsera-usw2-np
  HUB_CLUSTER: argocd-usw2
  TENANT: opsera

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: "‚úÖ Validate"
    runs-on: ubuntu-latest
    if: inputs.confirm == true
    outputs:
      aws_account_id: ${{ steps.account.outputs.account_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ AWS Account: ${ACCOUNT_ID}"

      - name: Verify EKS Clusters
        run: |
          echo "Verifying spoke cluster..."
          if aws eks describe-cluster --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "‚úÖ Spoke cluster exists: ${{ env.EKS_CLUSTER }}"
          else
            echo "‚ùå Spoke cluster not found: ${{ env.EKS_CLUSTER }}"
            exit 1
          fi

          echo "Verifying hub cluster..."
          if aws eks describe-cluster --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "‚úÖ Hub cluster exists: ${{ env.HUB_CLUSTER }}"
          else
            echo "‚ùå Hub cluster not found: ${{ env.HUB_CLUSTER }}"
            exit 1
          fi

  create-ecr-repos:
    name: "üì¶ Create ECR Repos"
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repositories
        run: |
          for REPO in "${{ env.TENANT }}/${{ env.APP_NAME }}-frontend" "${{ env.TENANT }}/${{ env.APP_NAME }}-backend"; do
            if aws ecr describe-repositories --repository-names "$REPO" 2>/dev/null; then
              echo "‚úÖ ECR repository already exists: $REPO"
            else
              echo "üì¶ Creating ECR repository: $REPO"
              aws ecr create-repository \
                --repository-name "$REPO" \
                --image-scanning-configuration scanOnPush=true \
                --image-tag-mutability MUTABLE
              echo "‚úÖ Created: $REPO"
            fi
          done

  setup-argocd:
    name: "üîÑ Setup ArgoCD"
    needs: [validate, create-ecr-repos]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Hub Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Create ArgoCD Repository Secret
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          SECRET_NAME="repo-${{ env.APP_NAME }}"
          REPO_URL="https://github.com/${{ github.repository }}"

          if kubectl get secret "$SECRET_NAME" -n argocd >/dev/null 2>&1; then
            echo "‚úÖ Repository secret already exists: $SECRET_NAME"
          else
            echo "üîê Creating repository secret..."
            kubectl create secret generic "$SECRET_NAME" -n argocd \
              --from-literal=type=git \
              --from-literal=url="$REPO_URL" \
              --from-literal=password="$GH_PAT" \
              --from-literal=username=git

            kubectl label secret "$SECRET_NAME" -n argocd \
              argocd.argoproj.io/secret-type=repository
            echo "‚úÖ Created: $SECRET_NAME"
          fi

      - name: Apply ArgoCD Application
        run: |
          ENVIRONMENT="${{ inputs.environment }}"
          APP_FILE=".opsera-${{ env.APP_NAME }}/argocd/${ENVIRONMENT}/application.yaml"

          if [ -f "$APP_FILE" ]; then
            echo "Applying ArgoCD Application..."
            kubectl apply -f "$APP_FILE"
            echo "‚úÖ ArgoCD Application applied: ${{ env.APP_NAME }}-${ENVIRONMENT}"
          else
            echo "‚ùå Application file not found: $APP_FILE"
            exit 1
          fi

      - name: Verify ArgoCD Application
        run: |
          APP_NAME="${{ env.APP_NAME }}-${{ inputs.environment }}"
          sleep 5

          if kubectl get application $APP_NAME -n argocd >/dev/null 2>&1; then
            echo "‚úÖ ArgoCD Application created successfully"
            kubectl get application $APP_NAME -n argocd -o wide
          else
            echo "‚ùå ArgoCD Application not found"
            exit 1
          fi

  setup-spoke:
    name: "üéØ Setup Spoke Cluster"
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for Spoke Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Create Namespace
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"

          if kubectl get namespace $NAMESPACE >/dev/null 2>&1; then
            echo "‚úÖ Namespace already exists: $NAMESPACE"
          else
            echo "üìÅ Creating namespace: $NAMESPACE"
            kubectl create namespace $NAMESPACE
            kubectl label namespace $NAMESPACE \
              app=${{ env.APP_NAME }} \
              tenant=${{ env.TENANT }} \
              environment=${{ inputs.environment }}
            echo "‚úÖ Created: $NAMESPACE"
          fi

      - name: Create ECR Pull Secret
        run: |
          NAMESPACE="${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }}"
          ACCOUNT_ID="${{ needs.validate.outputs.aws_account_id }}"
          ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"

          # Get ECR auth token
          ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})

          # Create or update ECR pull secret
          kubectl create secret docker-registry ecr-registry-secret \
            --docker-server=$ECR_REGISTRY \
            --docker-username=AWS \
            --docker-password="$ECR_TOKEN" \
            -n $NAMESPACE \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ ECR pull secret created/updated"

  summary:
    name: "üìã Summary"
    needs: [validate, create-ecr-repos, setup-argocd, setup-spoke]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          # üèóÔ∏è Bootstrap Complete - ${{ env.APP_NAME }}

          ## Status
          | Component | Status |
          |-----------|--------|
          | Validation | ${{ needs.validate.result }} |
          | ECR Repos | ${{ needs.create-ecr-repos.result }} |
          | ArgoCD Setup | ${{ needs.setup-argocd.result }} |
          | Spoke Setup | ${{ needs.setup-spoke.result }} |

          ## Configuration
          | Field | Value |
          |-------|-------|
          | **App Name** | ${{ env.APP_NAME }} |
          | **Environment** | ${{ inputs.environment }} |
          | **Region** | ${{ env.AWS_REGION }} |
          | **Spoke Cluster** | ${{ env.EKS_CLUSTER }} |
          | **Hub Cluster** | ${{ env.HUB_CLUSTER }} |
          | **Namespace** | ${{ env.TENANT }}-${{ env.APP_NAME }}-${{ inputs.environment }} |

          ## ECR Repositories
          - \`${{ env.TENANT }}/${{ env.APP_NAME }}-frontend\`
          - \`${{ env.TENANT }}/${{ env.APP_NAME }}-backend\`

          ## Next Steps
          1. **Deploy the application:**
             \`\`\`bash
             git push origin main
             # OR
             gh workflow run "ci-build-push-${{ env.APP_NAME }}.yaml"
             \`\`\`

          2. **Setup DNS (one-time):**
             \`\`\`bash
             gh workflow run "dns-setup-${{ env.APP_NAME }}.yaml" -f environment=${{ inputs.environment }}
             \`\`\`

          ---
          *Powered by Opsera Code-to-Cloud Enterprise v1.7.3*
          EOF
