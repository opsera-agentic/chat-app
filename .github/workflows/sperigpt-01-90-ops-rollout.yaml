# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  ROLLOUT OPERATIONS - Promote, Abort, Retry for sperigpt-01                  â•‘
# â•‘  Code-to-Cloud v0.6 - Powered by Opsera                                       â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "âš¡ sperigpt-01: 90 Rollout Operations"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - qa
          - staging
        default: 'qa'
      action:
        description: 'Rollout action'
        required: true
        type: choice
        options:
          - status
          - promote
          - abort
          - retry
        default: 'status'
      service:
        description: 'Target service'
        required: true
        type: choice
        options:
          - both
          - frontend
          - backend
        default: 'both'

env:
  AWS_REGION: us-west-2
  TENANT: opsera
  APP_NAME: sperigpt-01

permissions:
  contents: read
  id-token: write

jobs:
  rollout-action:
    name: "âš¡ ${{ inputs.action }} - ${{ inputs.environment }}"
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl and Argo Rollouts Plugin
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install Argo Rollouts kubectl plugin
          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Connect to Spoke Cluster
        run: |
          case "${{ env.AWS_REGION }}" in
            us-west-2) REGION_SHORT="usw2" ;;
            us-east-1) REGION_SHORT="use1" ;;
            *) REGION_SHORT=$(echo "${{ env.AWS_REGION }}" | sed 's/-//g' | cut -c1-4) ;;
          esac

          SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-np"
          aws eks update-kubeconfig --name $SPOKE_CLUSTER --region ${{ env.AWS_REGION }}

      - name: Execute Rollout Action
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"
          ACTION="${{ inputs.action }}"
          SERVICE="${{ inputs.service }}"

          echo "## âš¡ Rollout Operation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Action | \`${ACTION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Service | \`${SERVICE}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine which rollouts to target
          if [ "$SERVICE" = "both" ]; then
            ROLLOUTS="frontend-rollout backend-rollout"
          else
            ROLLOUTS="${SERVICE}-rollout"
          fi

          for ROLLOUT in $ROLLOUTS; do
            echo "### ðŸ“¦ ${ROLLOUT}" >> $GITHUB_STEP_SUMMARY

            case "$ACTION" in
              status)
                echo '```' >> $GITHUB_STEP_SUMMARY
                kubectl argo rollouts status $ROLLOUT -n $NAMESPACE 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
                echo '```' >> $GITHUB_STEP_SUMMARY
                ;;

              promote)
                kubectl argo rollouts promote $ROLLOUT -n $NAMESPACE
                echo "- âœ… Promoted \`${ROLLOUT}\`" >> $GITHUB_STEP_SUMMARY
                ;;

              abort)
                kubectl argo rollouts abort $ROLLOUT -n $NAMESPACE
                echo "- âš ï¸ Aborted \`${ROLLOUT}\`" >> $GITHUB_STEP_SUMMARY
                ;;

              retry)
                kubectl argo rollouts retry rollout $ROLLOUT -n $NAMESPACE
                echo "- ðŸ”„ Retried \`${ROLLOUT}\`" >> $GITHUB_STEP_SUMMARY
                ;;
            esac

            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Show Current Status
        if: inputs.action != 'status'
        run: |
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"

          echo "### ðŸ“Š Current Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl argo rollouts list rollouts -n $NAMESPACE 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
