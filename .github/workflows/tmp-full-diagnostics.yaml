# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  FULL DIAGNOSTICS - Deep investigation of entire CI/CD pipeline              â•‘
# â•‘  Generated by Code-to-Cloud v0.6 - Powered by Opsera                         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”¬ Full Pipeline Diagnostics"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  APP_NAME: chat-app
  NAMESPACE: chat-app-qa

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: VERIFY SOURCE CODE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-source:
    name: "ðŸ“ Stage 1: Verify Source Code"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ“‹ Log: Repository Info"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  STAGE 1: SOURCE CODE VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“ Repository: ${{ github.repository }}"
          echo "ðŸ“ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ“ Commit Message: $(git log -1 --pretty=%B)"
          echo ""
          
          echo "## ðŸ“ Stage 1: Source Code Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‚ Log: Directory Structure"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  DIRECTORY STRUCTURE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "### .opsera-chat-app structure:"
          find .opsera-${{ env.APP_NAME }} -type f | sort
          echo ""
          
          echo "### Directory Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find .opsera-${{ env.APP_NAME }} -type f | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“„ Log: QA Kustomization.yaml Content"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  QA KUSTOMIZATION.YAML CONTENT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          cat .opsera-${{ env.APP_NAME }}/k8s/overlays/qa/kustomization.yaml
          echo ""
          
          echo "### QA Kustomization.yaml" >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          cat .opsera-${{ env.APP_NAME }}/k8s/overlays/qa/kustomization.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ” Log: Verify All Referenced Files Exist"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  VERIFY REFERENCED FILES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          cd .opsera-${{ env.APP_NAME }}/k8s/overlays/qa
          
          echo "### File Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          FILES=(
            "namespace.yaml"
            "frontend-service.yaml"
            "backend-service.yaml"
            "frontend-rollout.yaml"
            "backend-rollout.yaml"
            "frontend-canary-service.yaml"
            "backend-canary-service.yaml"
            "patch-ingress.yaml"
            "patch-configmap.yaml"
          )
          
          ALL_EXIST=true
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
              echo "- âœ… \`$file\` exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $file MISSING!"
              echo "- âŒ \`$file\` **MISSING**" >> $GITHUB_STEP_SUMMARY
              ALL_EXIST=false
            fi
          done
          
          if [ "$ALL_EXIST" = false ]; then
            echo ""
            echo "âŒ Some files are missing!"
            exit 1
          fi

      - name: "ðŸ”§ Log: Test Kustomize Build Locally"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  TEST KUSTOMIZE BUILD"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
          
          echo "Kustomize version:"
          kustomize version
          echo ""
          
          echo "### Kustomize Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Building kustomize..."
          cd .opsera-${{ env.APP_NAME }}/k8s/overlays/qa
          
          if kustomize build . > /tmp/kustomize-output.yaml 2>&1; then
            echo "âœ… Kustomize build SUCCEEDED"
            echo "âœ… **Kustomize build SUCCEEDED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Generated manifest preview (first 100 lines):" >> $GITHUB_STEP_SUMMARY
            echo '```yaml' >> $GITHUB_STEP_SUMMARY
            head -100 /tmp/kustomize-output.yaml >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Kustomize build FAILED"
            echo "âŒ **Kustomize build FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Error output:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/kustomize-output.yaml >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: VERIFY ECR IMAGES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-ecr:
    name: "ðŸ³ Stage 2: Verify ECR Images"
    runs-on: ubuntu-latest
    needs: [verify-source]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: "ðŸ“‹ Log: AWS Identity"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  STAGE 2: ECR IMAGE VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "AWS Identity:"
          aws sts get-caller-identity
          echo ""
          
          echo "## ðŸ³ Stage 2: ECR Image Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ³ Log: Check ECR Repositories"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ECR REPOSITORIES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### ECR Repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for REPO in ${{ env.APP_NAME }}-frontend ${{ env.APP_NAME }}-backend; do
            echo "Checking repository: $REPO"
            if aws ecr describe-repositories --repository-names $REPO 2>/dev/null; then
              echo "âœ… Repository $REPO exists"
              echo "- âœ… \`$REPO\` exists" >> $GITHUB_STEP_SUMMARY
              
              echo "  Latest images:"
              aws ecr describe-images --repository-name $REPO \
                --query 'sort_by(imageDetails,& imagePushedAt)[-3:].{Tag:imageTags[0],Pushed:imagePushedAt,Size:imageSizeInBytes}' \
                --output table 2>/dev/null || echo "  No images found"
            else
              echo "âŒ Repository $REPO NOT FOUND"
              echo "- âŒ \`$REPO\` **NOT FOUND**" >> $GITHUB_STEP_SUMMARY
            fi
            echo ""
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: VERIFY ARGOCD HUB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-argocd:
    name: "ðŸŽ¯ Stage 3: Verify ArgoCD Hub"
    runs-on: ubuntu-latest
    needs: [verify-ecr]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Hub Cluster
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  STAGE 3: ARGOCD HUB VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "âœ… Connected to Hub cluster: ${{ env.HUB_CLUSTER }}"
          
          echo "## ðŸŽ¯ Stage 3: ArgoCD Hub Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‹ Log: ArgoCD Server Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ARGOCD SERVER STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### ArgoCD Server Pods" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‹ Log: All ArgoCD Applications"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ALL ARGOCD APPLICATIONS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### All Applications" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get applications -n argocd 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ” Log: Chat-App Application Details"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CHAT-APP-QA APPLICATION DETAILS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP="${{ env.APP_NAME }}-qa"
          
          echo "### Application: $APP" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get full YAML
          echo "Full Application YAML:"
          kubectl get application $APP -n argocd -o yaml 2>&1 | tee /tmp/app.yaml
          
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          cat /tmp/app.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ” Log: Application Sync Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  APPLICATION SYNC STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP="${{ env.APP_NAME }}-qa"
          
          echo "### Sync Status Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Sync Status:"
          SYNC=$(kubectl get application $APP -n argocd -o jsonpath='{.status.sync.status}' 2>&1)
          echo "  Status: $SYNC"
          echo "- **Sync Status**: \`$SYNC\`" >> $GITHUB_STEP_SUMMARY
          
          echo "Health Status:"
          HEALTH=$(kubectl get application $APP -n argocd -o jsonpath='{.status.health.status}' 2>&1)
          echo "  Status: $HEALTH"
          echo "- **Health Status**: \`$HEALTH\`" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Operation State:"
          kubectl get application $APP -n argocd -o jsonpath='{.status.operationState}' 2>&1 | jq . || echo "No operation state"
          
          echo ""
          echo "Conditions (Errors):"
          echo "### Conditions/Errors" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application $APP -n argocd -o jsonpath='{.status.conditions[*]}' 2>&1 | jq . | tee -a $GITHUB_STEP_SUMMARY || echo "No conditions"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ” Log: Application Source Config"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  APPLICATION SOURCE CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP="${{ env.APP_NAME }}-qa"
          
          echo "### Source Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Repository URL:"
          REPO=$(kubectl get application $APP -n argocd -o jsonpath='{.spec.source.repoURL}' 2>&1)
          echo "  $REPO"
          echo "- **Repo URL**: \`$REPO\`" >> $GITHUB_STEP_SUMMARY
          
          echo "Path:"
          PATH_VAL=$(kubectl get application $APP -n argocd -o jsonpath='{.spec.source.path}' 2>&1)
          echo "  $PATH_VAL"
          echo "- **Path**: \`$PATH_VAL\`" >> $GITHUB_STEP_SUMMARY
          
          echo "Target Revision:"
          REV=$(kubectl get application $APP -n argocd -o jsonpath='{.spec.source.targetRevision}' 2>&1)
          echo "  $REV"
          echo "- **Target Revision**: \`$REV\`" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Destination:"
          DEST_NAME=$(kubectl get application $APP -n argocd -o jsonpath='{.spec.destination.name}' 2>&1)
          DEST_NS=$(kubectl get application $APP -n argocd -o jsonpath='{.spec.destination.namespace}' 2>&1)
          echo "  Cluster: $DEST_NAME"
          echo "  Namespace: $DEST_NS"
          echo "- **Destination Cluster**: \`$DEST_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination Namespace**: \`$DEST_NS\`" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ”„ Log: Force Hard Refresh"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  FORCING HARD REFRESH"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP="${{ env.APP_NAME }}-qa"
          
          echo "### Force Hard Refresh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Adding hard refresh annotation..."
          kubectl annotate application $APP -n argocd argocd.argoproj.io/refresh=hard --overwrite 2>&1
          echo "âœ… Hard refresh annotation added" >> $GITHUB_STEP_SUMMARY
          
          echo "Waiting 15 seconds for refresh..."
          sleep 15
          
          echo ""
          echo "Checking status after refresh:"
          SYNC=$(kubectl get application $APP -n argocd -o jsonpath='{.status.sync.status}' 2>&1)
          echo "  Sync Status: $SYNC"
          echo "- **Post-Refresh Sync Status**: \`$SYNC\`" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Conditions after refresh:"
          kubectl get application $APP -n argocd -o jsonpath='{.status.conditions[*].message}' 2>&1 || echo "No conditions"

      - name: "ðŸ”„ Log: Trigger Sync Operation"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  TRIGGERING SYNC OPERATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          APP="${{ env.APP_NAME }}-qa"
          
          echo "### Sync Operation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "Patching application to trigger sync..."
          kubectl patch application $APP -n argocd \
            --type merge \
            -p '{"operation":{"initiatedBy":{"username":"diagnostics-workflow"},"sync":{"prune":true}}}' 2>&1 || echo "Patch may have failed"
          
          echo "âœ… Sync operation triggered" >> $GITHUB_STEP_SUMMARY
          
          echo "Waiting 30 seconds for sync..."
          sleep 30
          
          echo ""
          echo "Checking status after sync attempt:"
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get application $APP -n argocd -o jsonpath='{.status.sync.status}' 2>&1 | tee -a $GITHUB_STEP_SUMMARY && echo ""
          kubectl get application $APP -n argocd -o jsonpath='{.status.operationState.phase}' 2>&1 | tee -a $GITHUB_STEP_SUMMARY && echo ""
          echo '```' >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: VERIFY SPOKE CLUSTER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-spoke:
    name: "â˜¸ï¸ Stage 4: Verify Spoke Cluster"
    runs-on: ubuntu-latest
    needs: [verify-argocd]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Spoke Cluster
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  STAGE 4: SPOKE CLUSTER VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "âœ… Connected to Spoke cluster: ${{ env.SPOKE_CLUSTER }}"
          
          echo "## â˜¸ï¸ Stage 4: Spoke Cluster Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‹ Log: Namespace Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  NAMESPACE STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Namespace: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if kubectl get namespace ${{ env.NAMESPACE }} 2>/dev/null; then
            echo "âœ… Namespace exists"
            echo "âœ… Namespace \`${{ env.NAMESPACE }}\` exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Namespace does NOT exist"
            echo "âŒ Namespace \`${{ env.NAMESPACE }}\` **does NOT exist**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "ðŸ“‹ Log: All Resources in Namespace"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ALL RESOURCES IN NAMESPACE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### All Resources" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‹ Log: Pods Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PODS STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Pods" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Pod descriptions (if any):"
          kubectl describe pods -n ${{ env.NAMESPACE }} 2>&1 | head -100 || echo "No pods to describe"

      - name: "ðŸ“‹ Log: Services Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  SERVICES STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get services -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: "ðŸ“‹ Log: Rollouts Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ROLLOUTS STATUS (Argo Rollouts)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Rollouts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get rollouts -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Rollout descriptions (if any):"
          kubectl describe rollouts -n ${{ env.NAMESPACE }} 2>&1 | head -100 || echo "No rollouts to describe"

      - name: "ðŸ“‹ Log: Ingress Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  INGRESS STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Ingress" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Ingress description:"
          kubectl describe ingress -n ${{ env.NAMESPACE }} 2>&1 || echo "No ingress to describe"

      - name: "ðŸ“‹ Log: Certificates Status"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  CERTIFICATES STATUS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Certificates" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get certificates -n ${{ env.NAMESPACE }} 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Certificate Requests:"
          kubectl get certificaterequests -n ${{ env.NAMESPACE }} 2>&1 || echo "No certificate requests"
          
          echo ""
          echo "Challenges:"
          kubectl get challenges -n ${{ env.NAMESPACE }} 2>&1 || echo "No challenges"

      - name: "ðŸ“‹ Log: Events"
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  RECENT EVENTS IN NAMESPACE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "### Recent Events" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' 2>&1 | tail -30 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“Š Final Summary"
    runs-on: ubuntu-latest
    needs: [verify-source, verify-ecr, verify-argocd, verify-spoke]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“Š Diagnostics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Source Code | ${{ needs.verify-source.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. ECR Images | ${{ needs.verify-ecr.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. ArgoCD Hub | ${{ needs.verify-argocd.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Spoke Cluster | ${{ needs.verify-spoke.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the full logs for each stage above." >> $GITHUB_STEP_SUMMARY
