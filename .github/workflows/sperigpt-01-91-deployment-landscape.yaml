# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  DEPLOYMENT LANDSCAPE - Visual Pipeline & Architecture Dashboard             â•‘
# â•‘  sperigpt-01 - Code-to-Cloud v0.6 - Powered by Opsera                        â•‘
# â•‘                                                                               â•‘
# â•‘  FEATURES:                                                                    â•‘
# â•‘  - Live deployment status across all environments                             â•‘
# â•‘  - Numbered sequence flow with tool icons                                     â•‘
# â•‘  - Cloud architecture visualization                                           â•‘
# â•‘  - Professional Mermaid diagrams (white background)                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ğŸ“Š sperigpt-01: 91 Deployment Landscape"

on:
  workflow_dispatch:
    inputs:
      include_live_data:
        description: 'Fetch live deployment data from clusters'
        required: false
        type: boolean
        default: true
      generate_artifact:
        description: 'Generate downloadable diagram artifact'
        required: false
        type: boolean
        default: false
  schedule:
    # Run daily at 6 AM UTC for dashboard updates
    - cron: '0 6 * * *'

env:
  AWS_REGION: us-west-2
  APP_NAME: sperigpt-01
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  DOMAIN: agent.opsera.dev

permissions:
  contents: read
  id-token: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GATHER LIVE DATA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gather-data:
    name: "ğŸ“¡ Gather Live Data"
    runs-on: ubuntu-latest
    outputs:
      dev_image: ${{ steps.dev.outputs.image_tag }}
      dev_status: ${{ steps.dev.outputs.status }}
      dev_pods: ${{ steps.dev.outputs.pods }}
      qa_image: ${{ steps.qa.outputs.image_tag }}
      qa_status: ${{ steps.qa.outputs.status }}
      qa_pods: ${{ steps.qa.outputs.pods }}
      qa_canary_weight: ${{ steps.qa.outputs.canary_weight }}
      staging_image: ${{ steps.staging.outputs.image_tag }}
      staging_status: ${{ steps.staging.outputs.status }}
      staging_pods: ${{ steps.staging.outputs.pods }}
      staging_active: ${{ steps.staging.outputs.active_color }}
      ecr_images: ${{ steps.ecr.outputs.latest_images }}
      argocd_apps: ${{ steps.argocd.outputs.apps }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -sLO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      - name: Get ECR Images
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # Get latest 3 images for frontend
          FRONTEND_TAGS=$(aws ecr describe-images \
            --repository-name ${{ env.APP_NAME }}-frontend \
            --query 'imageDetails | sort_by(@, &imagePushedAt) | [-3:].imageTags[0]' \
            --output text 2>/dev/null | tr '\t' ',' || echo "none")

          # Get latest 3 images for backend
          BACKEND_TAGS=$(aws ecr describe-images \
            --repository-name ${{ env.APP_NAME }}-backend \
            --query 'imageDetails | sort_by(@, &imagePushedAt) | [-3:].imageTags[0]' \
            --output text 2>/dev/null | tr '\t' ',' || echo "none")

          echo "latest_images=frontend:${FRONTEND_TAGS}|backend:${BACKEND_TAGS}" >> $GITHUB_OUTPUT

      - name: Connect to Spoke Cluster
        if: inputs.include_live_data != false
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Get DEV Status
        id: dev
        if: inputs.include_live_data != false
        run: |
          NS="${{ env.APP_NAME }}-dev"

          # Get image tag from deployment
          IMAGE_TAG=$(kubectl get deployment frontend-deployment -n $NS \
            -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null | rev | cut -d: -f1 | rev || echo "unknown")

          # Get pod count
          READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c Running || echo "0")
          TOTAL=$(kubectl get pods -n $NS --no-headers 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          # Determine status
          if [ "$READY" = "$TOTAL" ] && [ "$TOTAL" != "0" ]; then
            STATUS="healthy"
          elif [ "$TOTAL" = "0" ]; then
            STATUS="not-deployed"
          else
            STATUS="degraded"
          fi

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "pods=${READY}/${TOTAL}" >> $GITHUB_OUTPUT

      - name: Get QA Status (Canary)
        id: qa
        if: inputs.include_live_data != false
        run: |
          NS="${{ env.APP_NAME }}-qa"

          # Get image tag from rollout
          IMAGE_TAG=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null | rev | cut -d: -f1 | rev || echo "unknown")

          # Get rollout status
          PHASE=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

          # Get canary weight
          WEIGHT=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")

          # Get pod count
          READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c Running || echo "0")
          TOTAL=$(kubectl get pods -n $NS --no-headers 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "status=${PHASE}" >> $GITHUB_OUTPUT
          echo "pods=${READY}/${TOTAL}" >> $GITHUB_OUTPUT
          echo "canary_weight=${WEIGHT}" >> $GITHUB_OUTPUT

      - name: Get Staging Status (Blue-Green)
        id: staging
        if: inputs.include_live_data != false
        run: |
          NS="${{ env.APP_NAME }}-staging"

          # Get image tag from rollout
          IMAGE_TAG=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null | rev | cut -d: -f1 | rev || echo "unknown")

          # Get rollout status
          PHASE=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

          # Get active ReplicaSet color (blue or green)
          ACTIVE=$(kubectl get rollout frontend-rollout -n $NS \
            -o jsonpath='{.status.blueGreen.activeSelector}' 2>/dev/null || echo "unknown")

          # Get pod count
          READY=$(kubectl get pods -n $NS --no-headers 2>/dev/null | grep -c Running || echo "0")
          TOTAL=$(kubectl get pods -n $NS --no-headers 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "status=${PHASE}" >> $GITHUB_OUTPUT
          echo "pods=${READY}/${TOTAL}" >> $GITHUB_OUTPUT
          echo "active_color=${ACTIVE}" >> $GITHUB_OUTPUT

      - name: Get ArgoCD App Status
        id: argocd
        if: inputs.include_live_data != false
        run: |
          # Switch to hub cluster
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}

          # Get all app statuses
          APPS=$(kubectl get applications -n argocd -l app.kubernetes.io/instance=${{ env.APP_NAME }} \
            -o jsonpath='{range .items[*]}{.metadata.name}:{.status.sync.status}:{.status.health.status},{end}' 2>/dev/null || echo "none")

          echo "apps=${APPS}" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GENERATE LANDSCAPE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-landscape:
    name: "ğŸ¨ Generate Landscape"
    runs-on: ubuntu-latest
    needs: [gather-data]

    steps:
      - name: Generate Deployment Landscape
        env:
          DEV_IMAGE: ${{ needs.gather-data.outputs.dev_image }}
          DEV_STATUS: ${{ needs.gather-data.outputs.dev_status }}
          DEV_PODS: ${{ needs.gather-data.outputs.dev_pods }}
          QA_IMAGE: ${{ needs.gather-data.outputs.qa_image }}
          QA_STATUS: ${{ needs.gather-data.outputs.qa_status }}
          QA_PODS: ${{ needs.gather-data.outputs.qa_pods }}
          QA_WEIGHT: ${{ needs.gather-data.outputs.qa_canary_weight }}
          STAGING_IMAGE: ${{ needs.gather-data.outputs.staging_image }}
          STAGING_STATUS: ${{ needs.gather-data.outputs.staging_status }}
          STAGING_PODS: ${{ needs.gather-data.outputs.staging_pods }}
          STAGING_ACTIVE: ${{ needs.gather-data.outputs.staging_active }}
        run: |
          # Status emoji mapping
          status_emoji() {
            case "$1" in
              healthy|Healthy) echo "âœ…" ;;
              Progressing) echo "ğŸ”„" ;;
              Paused) echo "â¸ï¸" ;;
              degraded|Degraded) echo "âŒ" ;;
              not-deployed) echo "âšª" ;;
              *) echo "â“" ;;
            esac
          }

          DEV_EMOJI=$(status_emoji "$DEV_STATUS")
          QA_EMOJI=$(status_emoji "$QA_STATUS")
          STAGING_EMOJI=$(status_emoji "$STAGING_STATUS")

          cat >> $GITHUB_STEP_SUMMARY << 'HEADER'
          # ğŸ“Š Deployment Landscape Dashboard

          > **Application:** `sperigpt-01` | **Generated:** $(date -u '+%Y-%m-%d %H:%M UTC') | **Platform:** Code-to-Cloud v0.6

          ---

          ## ğŸ—ï¸ Architecture Overview

          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                           SPERIGPT-01 DEPLOYMENT ARCHITECTURE                           â”‚
          â”‚                              Powered by Opsera Code-to-Cloud                            â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â‘  SOURCE CONTROL                          â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
                    â”‚  â”‚ GitHub  â”‚  main branch â€¢ Push triggers pipeline              â”‚
                    â”‚  â”‚   ğŸ™    â”‚  Path: frontend/** | backend/**                    â”‚
                    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â‘¡ CI PIPELINE (Parallel)                     â”‚
                    â”‚                                                                  â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
                    â”‚  â”‚ ğŸ”’ Quality Gates    â”‚    â”‚ ğŸ”¨ CI Build & Push  â”‚             â”‚
                    â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚             â”‚
                    â”‚  â”‚ â€¢ Gitleaks Secrets  â”‚    â”‚ â€¢ Docker Build      â”‚             â”‚
                    â”‚  â”‚ â€¢ SonarQube SAST    â”‚    â”‚ â€¢ ECR Push          â”‚             â”‚
                    â”‚  â”‚ â€¢ Grype SCA         â”‚    â”‚ â€¢ Kustomize Update  â”‚             â”‚
                    â”‚  â”‚ â€¢ License Check     â”‚    â”‚ â€¢ ArgoCD Sync       â”‚             â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                    â”‚                                        â”‚                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â‘¢ CONTAINER REGISTRY                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚  AWS ECR  ğŸ“¦                                                â”‚ â”‚
                    â”‚  â”‚  792373136340.dkr.ecr.us-west-2.amazonaws.com               â”‚ â”‚
                    â”‚  â”‚  â”œâ”€â”€ sperigpt-01-frontend                                   â”‚ â”‚
                    â”‚  â”‚  â””â”€â”€ sperigpt-01-backend                                    â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â‘£ GITOPS ENGINE                           â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚  ArgoCD (Hub: argocd-usw2)  ğŸ”„                              â”‚ â”‚
                    â”‚  â”‚  â”œâ”€â”€ sperigpt-01-dev      â†’ opsera-usw2-np                  â”‚ â”‚
                    â”‚  â”‚  â”œâ”€â”€ sperigpt-01-qa       â†’ opsera-usw2-np                  â”‚ â”‚
                    â”‚  â”‚  â””â”€â”€ sperigpt-01-staging  â†’ opsera-usw2-np                  â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â‘¤ KUBERNETES (EKS)                        â”‚
                    â”‚                     Spoke: opsera-usw2-np                        â”‚
                    â”‚                                        â”‚                         â”‚
                    â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚     â”‚               â”‚                  â”‚                  â”‚     â”‚
                    â”‚     â–¼               â–¼                  â–¼                  â”‚     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚     â”‚
                    â”‚  â”‚ DEV  â”‚      â”‚    QA    â”‚      â”‚  STAGING  â”‚            â”‚     â”‚
                    â”‚  â”‚â”€â”€â”€â”€â”€â”€â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚     â”‚
                    â”‚  â”‚Directâ”‚ â”€â”€â”€â–º â”‚  Canary  â”‚ â”€â”€â”€â–º â”‚Blue-Green â”‚            â”‚     â”‚
                    â”‚  â”‚Deployâ”‚      â”‚10â†’30â†’60â†’ â”‚      â”‚ + Preview â”‚            â”‚     â”‚
                    â”‚  â”‚      â”‚      â”‚   100%   â”‚      â”‚    URL    â”‚            â”‚     â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚     â”‚
                    â”‚                                                           â”‚     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                    â”‚                                                                  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â‘¥ TRAFFIC & ENDPOINTS                       â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚  â”‚  NGINX Ingress + cert-manager (Let's Encrypt)  ğŸ”           â”‚ â”‚
                    â”‚  â”‚                                                             â”‚ â”‚
                    â”‚  â”‚  DEV:     https://opsera-sperigpt-01-dev.agent.opsera.dev   â”‚ â”‚
                    â”‚  â”‚  QA:      https://opsera-sperigpt-01-qa.agent.opsera.dev    â”‚ â”‚
                    â”‚  â”‚  STAGING: https://opsera-sperigpt-01-staging.agent.opsera.devâ”‚ â”‚
                    â”‚  â”‚  PREVIEW: https://preview.opsera-sperigpt-01-staging...     â”‚ â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    â‘¦ OBSERVABILITY & TRACKING                    â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
                    â”‚  â”‚  NewRelic  â”‚  â”‚    Jira    â”‚  â”‚   Slack    â”‚                 â”‚
                    â”‚  â”‚    APM     â”‚  â”‚  Tickets   â”‚  â”‚   Alerts   â”‚                 â”‚
                    â”‚  â”‚    ğŸ“ˆ     â”‚  â”‚    ğŸ“‹     â”‚  â”‚    ğŸ’¬     â”‚                 â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          ```

          ---

          ## ğŸ“ˆ Live Environment Status

          HEADER

          # Add live status table
          cat >> $GITHUB_STEP_SUMMARY << EOF

          | Environment | Status | Image Tag | Pods | Strategy | Endpoint |
          |-------------|--------|-----------|------|----------|----------|
          | **DEV** | ${DEV_EMOJI} ${DEV_STATUS:-N/A} | \`${DEV_IMAGE:-unknown}\` | ${DEV_PODS:-0/0} | Direct Deploy | [ğŸ”— Link](https://opsera-${{ env.APP_NAME }}-dev.${{ env.DOMAIN }}) |
          | **QA** | ${QA_EMOJI} ${QA_STATUS:-N/A} | \`${QA_IMAGE:-unknown}\` | ${QA_PODS:-0/0} | Canary (${QA_WEIGHT:-0}%) | [ğŸ”— Link](https://opsera-${{ env.APP_NAME }}-qa.${{ env.DOMAIN }}) |
          | **STAGING** | ${STAGING_EMOJI} ${STAGING_STATUS:-N/A} | \`${STAGING_IMAGE:-unknown}\` | ${STAGING_PODS:-0/0} | Blue-Green (${STAGING_ACTIVE:-unknown}) | [ğŸ”— Link](https://opsera-${{ env.APP_NAME }}-staging.${{ env.DOMAIN }}) |

          EOF

      - name: Generate Pipeline Flow Diagram
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ---

          ## ğŸ”„ Pipeline Sequence Flow

          ```mermaid
          %%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4F46E5', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4338CA', 'lineColor': '#6366F1', 'secondaryColor': '#F3F4F6', 'tertiaryColor': '#EEF2FF', 'background': '#FFFFFF'}}}%%
          flowchart LR
              subgraph SRC["â‘  Source"]
                  A[("ğŸ™ GitHub<br/>main branch")]
              end

              subgraph CI["â‘¡ CI Pipeline"]
                  B["ğŸ”’ Quality Gates<br/>Gitleaks|SonarQube|Grype"]
                  C["ğŸ”¨ Build & Push<br/>Docker|ECR"]
              end

              subgraph REG["â‘¢ Registry"]
                  D[("ğŸ“¦ AWS ECR<br/>us-west-2")]
              end

              subgraph GITOPS["â‘£ GitOps"]
                  E["ğŸ”„ ArgoCD<br/>Hub: argocd-usw2"]
              end

              subgraph K8S["â‘¤ Kubernetes"]
                  F["ğŸŸ¢ DEV<br/>Direct Deploy"]
                  G["ğŸŸ¡ QA<br/>Canary 10â†’100%"]
                  H["ğŸ”µ STAGING<br/>Blue-Green"]
              end

              subgraph OBS["â‘¦ Observability"]
                  I["ğŸ“ˆ NewRelic"]
                  J["ğŸ“‹ Jira"]
              end

              A -->|push| B & C
              C -->|image| D
              D -->|sync| E
              E -->|deploy| F
              F -->|promote| G
              G -->|promote| H
              G -.->|metrics| I
              H -.->|ticket| J

              style A fill:#24292E,color:#fff
              style B fill:#DC2626,color:#fff
              style C fill:#2563EB,color:#fff
              style D fill:#F59E0B,color:#000
              style E fill:#10B981,color:#fff
              style F fill:#22C55E,color:#fff
              style G fill:#EAB308,color:#000
              style H fill:#3B82F6,color:#fff
              style I fill:#8B5CF6,color:#fff
              style J fill:#0052CC,color:#fff
          ```

          ---

          ## ğŸ› ï¸ Technology Stack

          | Layer | Technology | Purpose |
          |-------|------------|---------|
          | **Source Control** | GitHub | Repository, Actions CI/CD |
          | **Security** | Gitleaks, Grype, SonarQube | Secrets, SCA, SAST |
          | **Container** | Docker, AWS ECR | Build, Registry |
          | **GitOps** | ArgoCD, Kustomize | Declarative deployments |
          | **Orchestration** | AWS EKS, Argo Rollouts | Kubernetes, Progressive delivery |
          | **Networking** | NGINX Ingress, cert-manager | TLS, Routing |
          | **DNS** | Route53, ExternalDNS | Domain management |
          | **Observability** | NewRelic APM | Metrics, Analysis |
          | **Tracking** | Jira | Deployment tickets |

          ---

          ## ğŸ“Š Deployment Strategies Explained

          ### DEV: Direct Deployment
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Old Version â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (100%)        â”‚
          â”‚       â†“ (instant switch)                â”‚
          â”‚  New Version â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (100%)        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Duration: ~30 seconds | Rollback: Manual
          ```

          ### QA: Canary Deployment
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Step 1: â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10% â†’ Analysis      â”‚
          â”‚  Step 2: â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30% â†’ Pause 2m      â”‚
          â”‚  Step 3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60% â†’ Pause 2m      â”‚
          â”‚  Step 4: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% â†’ Complete     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Duration: ~12 minutes | Rollback: Automatic on failure
          Analysis: NewRelic APM (Error Rate â‰¤5%, Latency â‰¤500ms, Apdex â‰¥0.85)
          ```

          ### STAGING: Blue-Green Deployment
          ```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ”µ BLUE (Active)  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Live    â”‚
          â”‚  ğŸŸ¢ GREEN (Preview) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Test   â”‚
          â”‚       â†“ (instant switch after approval) â”‚
          â”‚  ğŸŸ¢ GREEN (Active) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Live    â”‚
          â”‚  ğŸ”µ BLUE (Standby) â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ Idle    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          Duration: Instant switch | Rollback: Instant switch back
          Preview URL: https://preview.opsera-sperigpt-01-staging.agent.opsera.dev
          ```

          ---

          ## ğŸ”— Quick Links

          | Resource | Link |
          |----------|------|
          | **DEV Environment** | https://opsera-sperigpt-01-dev.agent.opsera.dev |
          | **QA Environment** | https://opsera-sperigpt-01-qa.agent.opsera.dev |
          | **Staging Environment** | https://opsera-sperigpt-01-staging.agent.opsera.dev |
          | **Staging Preview** | https://preview.opsera-sperigpt-01-staging.agent.opsera.dev |
          | **GitHub Repository** | https://github.com/${{ github.repository }} |
          | **ArgoCD Dashboard** | https://argocd.opsera.dev |
          | **AWS Console (ECR)** | https://us-west-2.console.aws.amazon.com/ecr |

          ---

          ## ğŸ“‹ Workflow Reference

          | # | Workflow | Purpose | Trigger |
          |---|----------|---------|---------|
          | 00 | Bootstrap Infrastructure | One-time cluster setup | Manual |
          | 10 | Quality & Security Gates | SAST, SCA, Secrets scan | Push (parallel) |
          | 20 | CI Build & Push | Build, Push, Deploy | Push |
          | 30 | Setup HTTPS | cert-manager SSL | Manual |
          | 85 | Jira Integration | Deployment tracking | Auto/Manual |
          | 90 | Rollout Operations | Canary/BG controls | Manual |
          | 91 | Deployment Landscape | This dashboard | Manual/Scheduled |
          | 99 | Clean It All | Full teardown | Manual |

          ---

          <div align="center">

          **Code-to-Cloud v0.6** | Powered by **Opsera**

          *Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*

          </div>
          EOF

      - name: Summary Complete
        run: |
          echo ""
          echo "âœ… Deployment Landscape generated successfully!"
          echo "ğŸ“Š View the full dashboard in the workflow summary above"
