# Temporary workflow to debug certificate issues
name: "ðŸ” Debug: Certificate Status"

on:
  workflow_dispatch:

env:
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np
  NAMESPACE: chat-app-qa

permissions:
  contents: read
  id-token: write

jobs:
  debug:
    name: "ðŸ” Check Certificate Status"
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Connect to Cluster
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

      - name: Check Certificate Status
        run: |
          echo "## ðŸ” Certificate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Certificates in namespace" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get certificates -n ${{ env.NAMESPACE }} -o wide 2>&1 || echo "No certificates found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Certificate Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe certificates -n ${{ env.NAMESPACE }} 2>&1 || echo "No certificates to describe"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Certificate Requests
        run: |
          echo "### Certificate Requests" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get certificaterequests -n ${{ env.NAMESPACE }} 2>&1 || echo "No certificate requests"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Challenges
        run: |
          echo "### ACME Challenges (HTTP-01)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get challenges -A 2>&1 || echo "No challenges found"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Challenge Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe challenges -A 2>&1 | head -100 || echo "No challenges to describe"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Ingress
        run: |
          echo "### Ingress Configuration" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n ${{ env.NAMESPACE }} -o wide 2>&1
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Ingress Details" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl describe ingress -n ${{ env.NAMESPACE }} 2>&1 | head -80
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Pods Status
        run: |
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide 2>&1
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check ClusterIssuer
        run: |
          echo "### ClusterIssuer Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get clusterissuer letsencrypt-prod -o yaml 2>&1 | head -50 || echo "ClusterIssuer not found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check TLS Secret
        run: |
          echo "### TLS Secret" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get secret chat-app-qa-tls -n ${{ env.NAMESPACE }} 2>&1 || echo "TLS secret not found yet"
          echo '```' >> $GITHUB_STEP_SUMMARY
