# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CLEANUP - Remove all deployed resources                                       â•‘
# â•‘  Generated by Code-to-Cloud v0.6 - Powered by Opsera                          â•‘
# â•‘                                                                                â•‘
# â•‘  âš ï¸  WARNING: This will DELETE all resources for the specified environment    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ§¹ 99: Clean It All"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to clean'
        required: true
        type: string
        default: 'qa'
      delete_ecr_images:
        description: 'Also delete ECR images?'
        required: false
        type: boolean
        default: false
      delete_argocd_app:
        description: 'Delete ArgoCD Application?'
        required: false
        type: boolean
        default: true
      confirm:
        description: 'Type "DELETE" to confirm'
        required: true
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: chat-app
  TENANT: opsera

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: "ðŸ” Validate Confirmation"
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        run: |
          if [ "${{ inputs.confirm }}" != "DELETE" ]; then
            echo "âŒ Confirmation failed. You must type 'DELETE' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation accepted"

  cleanup-k8s:
    name: "ðŸ—‘ï¸ Delete Kubernetes Resources"
    runs-on: ubuntu-latest
    needs: [validate]
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Delete Namespace (Spoke Cluster)
        run: |
          SPOKE_CLUSTER="${{ env.TENANT }}-usw2-np"
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          aws eks update-kubeconfig --name $SPOKE_CLUSTER --region ${{ env.AWS_REGION }}
          
          echo "### ðŸ—‘ï¸ Deleting Kubernetes Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if kubectl get namespace $NAMESPACE &>/dev/null; then
            kubectl delete namespace $NAMESPACE --timeout=120s || true
            echo "âœ… Deleted namespace: \`${NAMESPACE}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Namespace \`${NAMESPACE}\` not found" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup-argocd:
    name: "ðŸ—‘ï¸ Delete ArgoCD Application"
    runs-on: ubuntu-latest
    needs: [validate]
    if: inputs.delete_argocd_app
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Delete ArgoCD Application (Hub Cluster)
        run: |
          HUB_CLUSTER="argocd-usw2"
          APP_NAME="${{ env.APP_NAME }}-${{ inputs.environment }}"
          
          aws eks update-kubeconfig --name $HUB_CLUSTER --region ${{ env.AWS_REGION }}
          
          echo "### ðŸ—‘ï¸ Deleting ArgoCD Application" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if kubectl get application $APP_NAME -n argocd &>/dev/null; then
            kubectl delete application $APP_NAME -n argocd --timeout=120s || true
            echo "âœ… Deleted ArgoCD app: \`${APP_NAME}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ArgoCD app \`${APP_NAME}\` not found" >> $GITHUB_STEP_SUMMARY
          fi

  cleanup-ecr:
    name: "ðŸ—‘ï¸ Delete ECR Images"
    runs-on: ubuntu-latest
    needs: [validate]
    if: inputs.delete_ecr_images
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete ECR Images
        run: |
          echo "### ðŸ—‘ï¸ Deleting ECR Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for REPO in ${{ env.APP_NAME }}-frontend ${{ env.APP_NAME }}-backend; do
            if aws ecr describe-repositories --repository-names $REPO &>/dev/null; then
              # Get all image IDs
              IMAGES=$(aws ecr list-images --repository-name $REPO --query 'imageIds[*]' --output json)
              
              if [ "$IMAGES" != "[]" ]; then
                aws ecr batch-delete-image --repository-name $REPO --image-ids "$IMAGES" || true
                echo "âœ… Deleted images from: \`${REPO}\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ No images in: \`${REPO}\`" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âš ï¸ Repository \`${REPO}\` not found" >> $GITHUB_STEP_SUMMARY
            fi
          done

  summary:
    name: "ðŸ“‹ Cleanup Summary"
    runs-on: ubuntu-latest
    needs: [cleanup-k8s, cleanup-argocd, cleanup-ecr]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ§¹ Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Namespace | ${{ needs.cleanup-k8s.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ArgoCD App | ${{ needs.cleanup-argocd.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Images | ${{ needs.cleanup-ecr.result }} |" >> $GITHUB_STEP_SUMMARY
