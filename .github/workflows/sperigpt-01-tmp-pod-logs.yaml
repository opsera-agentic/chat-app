# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  POD LOGS - Diagnose CrashLoopBackOff and runtime errors                      â•‘
# â•‘  sperigpt-01 - Code-to-Cloud v0.6 - Powered by Opsera                        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ“œ sperigpt-01: Pod Logs"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
        default: 'qa'
      service:
        description: 'Service to check'
        required: true
        type: choice
        options:
          - backend
          - frontend
        default: 'backend'

env:
  AWS_REGION: us-west-2
  TENANT: opsera
  APP_NAME: sperigpt-01

permissions:
  contents: read
  id-token: write

jobs:
  get-logs:
    name: "ðŸ“œ Get Pod Logs"
    runs-on: ubuntu-latest

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/

      - name: Get Pod Logs
        run: |
          case "${{ env.AWS_REGION }}" in
            us-west-2) REGION_SHORT="usw2" ;;
            *) REGION_SHORT=$(echo "${{ env.AWS_REGION }}" | sed 's/-//g' | cut -c1-4) ;;
          esac

          SPOKE_CLUSTER="${{ env.TENANT }}-${REGION_SHORT}-np"
          NAMESPACE="${{ env.APP_NAME }}-${{ inputs.environment }}"

          aws eks update-kubeconfig --name $SPOKE_CLUSTER --region ${{ env.AWS_REGION }}

          echo "## ðŸ“œ Pod Logs: ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY

          POD=$(kubectl get pods -n $NAMESPACE -l app=${{ inputs.service }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

          if [ -n "$POD" ]; then
            echo "### Pod: \`$POD\`" >> $GITHUB_STEP_SUMMARY

            # Pod status
            echo "### Status" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get pod $POD -n $NAMESPACE -o wide 2>&1 | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Current logs
            echo "### Current Logs (last 100 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs $POD -n $NAMESPACE --tail=100 2>&1 | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Previous container logs (if crashed)
            echo "### Previous Logs (if crashed)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs $POD -n $NAMESPACE --previous --tail=100 2>&1 | tee -a $GITHUB_STEP_SUMMARY || echo "No previous logs"
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Pod events
            echo "### Pod Events" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl describe pod $POD -n $NAMESPACE 2>&1 | grep -A 20 "Events:" | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No pods found matching label \`app=${{ inputs.service }}\`" >> $GITHUB_STEP_SUMMARY

            echo "### All Pods in Namespace" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl get pods -n $NAMESPACE 2>&1 | tee -a $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
