# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  CI BUILD & PUSH - Build Docker images and deploy with auto-promotion        â•‘
# â•‘  sperigpt-01 - Code-to-Cloud v0.6 - Powered by Opsera                        â•‘
# â•‘                                                                               â•‘
# â•‘  PROMOTION CHAIN: DEV â†’ QA (Canary) â†’ Staging (Blue-Green)                   â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ”¨ sperigpt-01: 20 CI Build & Push"

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.opsera-sperigpt-01/Dockerfile.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
        default: 'dev'
      auto_promote:
        description: 'Auto-promote to next environment on success'
        required: false
        type: boolean
        default: true
      image_tag:
        description: 'Use existing image tag (skip build)'
        required: false
        type: string

env:
  AWS_REGION: us-west-2
  APP_NAME: sperigpt-01

permissions:
  contents: write
  id-token: write
  actions: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # VERIFY BOOTSTRAP
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  verify-bootstrap:
    name: "ðŸ” Verify Bootstrap"
    runs-on: ubuntu-latest
    outputs:
      ecr_uri: ${{ steps.ecr.outputs.ecr_uri }}
      image_tag: ${{ steps.tag.outputs.image_tag }}
      environment: ${{ steps.env.outputs.environment }}
      next_environment: ${{ steps.env.outputs.next_environment }}
      auto_promote: ${{ steps.env.outputs.auto_promote }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine Environment
        id: env
        run: |
          # On push, start with DEV; on workflow_dispatch, use input
          if [ "${{ github.event_name }}" = "push" ]; then
            ENVIRONMENT="dev"
            AUTO_PROMOTE="true"
          else
            ENVIRONMENT="${{ inputs.environment }}"
            AUTO_PROMOTE="${{ inputs.auto_promote }}"
          fi

          # Determine next environment in chain
          case "$ENVIRONMENT" in
            dev) NEXT_ENV="qa" ;;
            qa) NEXT_ENV="staging" ;;
            staging) NEXT_ENV="" ;;
          esac

          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "next_environment=${NEXT_ENV}" >> $GITHUB_OUTPUT
          echo "auto_promote=${AUTO_PROMOTE}" >> $GITHUB_OUTPUT

          echo "### ðŸŽ¯ Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${ENVIRONMENT}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Next Environment | \`${NEXT_ENV:-none}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-Promote | \`${AUTO_PROMOTE}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Verify ECR Repositories Exist
        id: ecr
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          echo "ecr_uri=${ECR_URI}" >> $GITHUB_OUTPUT

          for REPO in ${{ env.APP_NAME }}-frontend ${{ env.APP_NAME }}-backend; do
            if ! aws ecr describe-repositories --repository-names $REPO 2>/dev/null; then
              echo "âŒ ECR repository $REPO not found. Run Bootstrap first!"
              exit 1
            fi
          done
          echo "âœ… All ECR repositories exist"

      - name: Generate or Use Existing Image Tag
        id: tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            echo "Using existing image tag: ${IMAGE_TAG}"
          else
            IMAGE_TAG="${GITHUB_SHA:0:7}-$(date +%Y%m%d%H%M%S)"
            echo "Generated new image tag: ${IMAGE_TAG}"
          fi
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "### ðŸ·ï¸ Image Tag: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD FRONTEND (skip if using existing tag)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-frontend:
    name: "ðŸ”¨ Build Frontend"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap]
    if: inputs.image_tag == ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ needs.verify-bootstrap.outputs.ecr_uri }}

      - name: Build and Push Frontend Image
        run: |
          FULL_IMAGE="${{ needs.verify-bootstrap.outputs.ecr_uri }}/${{ env.APP_NAME }}-frontend:${{ needs.verify-bootstrap.outputs.image_tag }}"

          docker build \
            --no-cache \
            --pull \
            -t "$FULL_IMAGE" \
            -f .opsera-${{ env.APP_NAME }}/Dockerfile.frontend \
            ./frontend

          docker push "$FULL_IMAGE"

          echo "### âœ… Frontend Image Built" >> $GITHUB_STEP_SUMMARY
          echo "\`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD BACKEND (skip if using existing tag)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-backend:
    name: "ðŸ”¨ Build Backend"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap]
    if: inputs.image_tag == ''

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ needs.verify-bootstrap.outputs.ecr_uri }}

      - name: Build and Push Backend Image
        run: |
          FULL_IMAGE="${{ needs.verify-bootstrap.outputs.ecr_uri }}/${{ env.APP_NAME }}-backend:${{ needs.verify-bootstrap.outputs.image_tag }}"

          docker build \
            --no-cache \
            --pull \
            -t "$FULL_IMAGE" \
            -f .opsera-${{ env.APP_NAME }}/Dockerfile.backend \
            ./backend

          docker push "$FULL_IMAGE"

          echo "### âœ… Backend Image Built" >> $GITHUB_STEP_SUMMARY
          echo "\`${FULL_IMAGE}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UPDATE MANIFESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-manifests:
    name: "ðŸ“ Update Manifests (${{ needs.verify-bootstrap.outputs.environment }})"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, build-frontend, build-backend]
    if: always() && needs.verify-bootstrap.result == 'success' && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Update Kustomization with New Image Tag
        env:
          IMAGE_TAG: ${{ needs.verify-bootstrap.outputs.image_tag }}
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
        run: |
          KUSTOMIZE_FILE=".opsera-${{ env.APP_NAME }}/k8s/overlays/${ENVIRONMENT}/kustomization.yaml"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main || true

          sed -i "s|newTag:.*|newTag: ${IMAGE_TAG}|g" "$KUSTOMIZE_FILE"

          echo "âœ… Updated kustomization.yaml with tag: ${IMAGE_TAG}"

      - name: Commit and Push Changes
        env:
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
        run: |
          git add .
          git diff --staged --quiet || git commit -m "chore(${ENVIRONMENT}): update images to ${{ needs.verify-bootstrap.outputs.image_tag }} [skip ci]"
          git push origin main || echo "No changes to push"

      - name: Summary
        env:
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
        run: |
          echo "### ðŸ“ Manifests Updated for ${ENVIRONMENT}" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ needs.verify-bootstrap.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | \`${{ needs.verify-bootstrap.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SYNC ARGOCD & WAIT FOR DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sync-and-wait:
    name: "ðŸ”„ Deploy to ${{ needs.verify-bootstrap.outputs.environment }}"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, update-manifests]
    if: always() && needs.update-manifests.result == 'success'
    outputs:
      deploy_success: ${{ steps.wait.outputs.success }}

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install kubectl and Argo Rollouts
        run: |
          curl -LO "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
          chmod +x kubectl-argo-rollouts-linux-amd64
          sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

      - name: Sync ArgoCD Application
        env:
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
        run: |
          HUB_CLUSTER="argocd-usw2"
          aws eks update-kubeconfig --name $HUB_CLUSTER --region ${{ env.AWS_REGION }}

          APP_NAME="${{ env.APP_NAME }}-${ENVIRONMENT}"

          kubectl patch application "$APP_NAME" -n argocd \
            --type merge -p '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'

          sleep 5

          kubectl patch application "$APP_NAME" -n argocd \
            --type merge -p '{"operation":{"initiatedBy":{"username":"github-actions"},"sync":{"prune":true}}}'

          echo "### ðŸ”„ ArgoCD Sync Triggered" >> $GITHUB_STEP_SUMMARY
          echo "- Application: \`$APP_NAME\`" >> $GITHUB_STEP_SUMMARY

      - name: Wait for Deployment
        id: wait
        env:
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
        run: |
          SPOKE_CLUSTER="opsera-usw2-np"
          aws eks update-kubeconfig --name $SPOKE_CLUSTER --region ${{ env.AWS_REGION }}

          NAMESPACE="${{ env.APP_NAME }}-${ENVIRONMENT}"

          echo "â³ Waiting for deployment to complete in ${NAMESPACE}..."

          # Wait for pods to be ready (max 5 minutes)
          TIMEOUT=300
          ELAPSED=0

          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Check if pods are running
            READY_PODS=$(kubectl get pods -n $NAMESPACE -o jsonpath='{.items[*].status.phase}' 2>/dev/null | tr ' ' '\n' | grep -c "Running" || echo "0")
            TOTAL_PODS=$(kubectl get pods -n $NAMESPACE --no-headers 2>/dev/null | wc -l || echo "0")

            if [ "$TOTAL_PODS" -gt 0 ] && [ "$READY_PODS" -eq "$TOTAL_PODS" ]; then
              echo "âœ… All $READY_PODS pods are running!"
              echo "success=true" >> $GITHUB_OUTPUT

              # For QA/Staging with rollouts, check rollout status
              if [ "$ENVIRONMENT" != "dev" ]; then
                echo "Checking rollout status..."
                kubectl argo rollouts status backend-rollout -n $NAMESPACE --timeout=180s || true
              fi

              echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
              echo "- Environment: \`${ENVIRONMENT}\`" >> $GITHUB_STEP_SUMMARY
              echo "- Pods Running: \`${READY_PODS}\`" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            echo "Waiting... ($READY_PODS/$TOTAL_PODS pods ready, ${ELAPSED}s elapsed)"
            sleep 15
            ELAPSED=$((ELAPSED + 15))
          done

          echo "âš ï¸ Deployment timed out after ${TIMEOUT}s"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "### âš ï¸ Deployment Timeout" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # AUTO-PROMOTE TO NEXT ENVIRONMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  auto-promote:
    name: "ðŸš€ Promote to ${{ needs.verify-bootstrap.outputs.next_environment }}"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, sync-and-wait]
    if: |
      always() &&
      needs.sync-and-wait.outputs.deploy_success == 'true' &&
      needs.verify-bootstrap.outputs.auto_promote == 'true' &&
      needs.verify-bootstrap.outputs.next_environment != ''

    steps:
      - name: Trigger Next Environment Deployment
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          NEXT_ENV: ${{ needs.verify-bootstrap.outputs.next_environment }}
          IMAGE_TAG: ${{ needs.verify-bootstrap.outputs.image_tag }}
        run: |
          echo "### ðŸš€ Auto-Promoting to ${NEXT_ENV}" >> $GITHUB_STEP_SUMMARY
          echo "- Image Tag: \`${IMAGE_TAG}\`" >> $GITHUB_STEP_SUMMARY

          gh workflow run "sperigpt-01-20-ci-build-push.yaml" \
            --repo ${{ github.repository }} \
            -f environment=${NEXT_ENV} \
            -f auto_promote=true \
            -f image_tag=${IMAGE_TAG}

          echo "âœ… Promotion triggered successfully" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: "ðŸ“‹ Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [verify-bootstrap, sync-and-wait, auto-promote]
    if: always()

    steps:
      - name: Generate Summary
        env:
          ENVIRONMENT: ${{ needs.verify-bootstrap.outputs.environment }}
          NEXT_ENV: ${{ needs.verify-bootstrap.outputs.next_environment }}
          DEPLOY_SUCCESS: ${{ needs.sync-and-wait.outputs.deploy_success }}
          AUTO_PROMOTE: ${{ needs.verify-bootstrap.outputs.auto_promote }}
        run: |
          echo "## ðŸ“‹ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Promotion Chain" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "DEV â”€â”€â–º QA (Canary) â”€â”€â–º Staging (Blue-Green)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy to ${ENVIRONMENT} | ${{ needs.sync-and-wait.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${AUTO_PROMOTE}" = "true" ] && [ -n "${NEXT_ENV}" ]; then
            echo "| Promote to ${NEXT_ENV} | ${{ needs.auto-promote.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| DEV | https://opsera-sperigpt-01-dev.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | https://opsera-sperigpt-01-qa.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | https://opsera-sperigpt-01-staging.agent.opsera.dev |" >> $GITHUB_STEP_SUMMARY
