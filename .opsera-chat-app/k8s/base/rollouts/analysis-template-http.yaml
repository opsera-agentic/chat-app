# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║  ANALYSIS TEMPLATE - HTTP Health Check (Job-Based - RULE 31)                   ║
# ║  Generated by Code-to-Cloud v0.6 - Powered by Opsera                          ║
# ║                                                                                ║
# ║  Uses Job provider instead of Web provider to properly handle secrets          ║
# ║  and ensure reliable health checks during canary rollouts.                     ║
# ╚══════════════════════════════════════════════════════════════════════════════╝

apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: http-health-check
  labels:
    app.kubernetes.io/component: canary-analysis
spec:
  args:
    - name: service-name
      value: "frontend-canary"
    - name: namespace
      value: "chat-app-qa"
    - name: success-threshold
      value: "95"
    - name: max-latency-ms
      value: "1000"

  metrics:
    # ════════════════════════════════════════════════════════════════════
    # HTTP HEALTH CHECK - Service availability
    # ════════════════════════════════════════════════════════════════════
    - name: http-health
      interval: 30s
      count: 10
      failureLimit: 3
      consecutiveErrorLimit: 3
      provider:
        job:
          spec:
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: health-check
                    image: curlimages/curl:8.5.0
                    env:
                      - name: SERVICE_NAME
                        value: "{{args.service-name}}"
                      - name: NAMESPACE
                        value: "{{args.namespace}}"
                      - name: MAX_LATENCY
                        value: "{{args.max-latency-ms}}"
                    command: ["/bin/sh", "-c"]
                    args:
                      - |
                        set -e
                        echo "╔══════════════════════════════════════════════════════════════╗"
                        echo "║  HTTP Health Check - Canary Analysis                          ║"
                        echo "╚══════════════════════════════════════════════════════════════╝"
                        
                        SERVICE_URL="http://${SERVICE_NAME}.${NAMESPACE}.svc.cluster.local"
                        
                        echo "Service: ${SERVICE_URL}"
                        echo "Max Latency: ${MAX_LATENCY}ms"
                        echo ""
                        
                        # Measure response time
                        START_TIME=$(date +%s%N)
                        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${SERVICE_URL}/" || echo "000")
                        END_TIME=$(date +%s%N)
                        
                        LATENCY=$(( (END_TIME - START_TIME) / 1000000 ))
                        
                        echo "HTTP Status: ${RESPONSE}"
                        echo "Latency: ${LATENCY}ms"
                        
                        # Check HTTP status
                        if [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 400 ]; then
                          echo "✅ HTTP Status OK (${RESPONSE})"
                        else
                          echo "❌ HTTP Status FAILED (${RESPONSE})"
                          exit 1
                        fi
                        
                        # Check latency
                        if [ "$LATENCY" -le "$MAX_LATENCY" ]; then
                          echo "✅ Latency OK (${LATENCY}ms <= ${MAX_LATENCY}ms)"
                        else
                          echo "❌ Latency EXCEEDED (${LATENCY}ms > ${MAX_LATENCY}ms)"
                          exit 1
                        fi
                        
                        echo ""
                        echo "✅ Health check PASSED"
                        exit 0

    # ════════════════════════════════════════════════════════════════════
    # BACKEND API HEALTH CHECK
    # ════════════════════════════════════════════════════════════════════
    - name: api-health
      interval: 30s
      count: 10
      failureLimit: 3
      provider:
        job:
          spec:
            backoffLimit: 1
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: api-check
                    image: curlimages/curl:8.5.0
                    env:
                      - name: NAMESPACE
                        value: "{{args.namespace}}"
                    command: ["/bin/sh", "-c"]
                    args:
                      - |
                        set -e
                        echo "Checking Backend API Health..."
                        
                        API_URL="http://backend-canary.${NAMESPACE}.svc.cluster.local:8000/health"
                        
                        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}" || echo "000")
                        
                        echo "API Health Endpoint: ${API_URL}"
                        echo "HTTP Status: ${RESPONSE}"
                        
                        if [ "$RESPONSE" -eq 200 ]; then
                          echo "✅ API Health OK"
                          exit 0
                        else
                          echo "❌ API Health FAILED"
                          exit 1
                        fi
